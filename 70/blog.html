<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
    <title>Getting rid of state machines (II) - 250bpm</title>
    
    	<script type="text/javascript" src="http://www.wikidot.com/default__flow/login__CustomDomainScript?site_id=148706"></script>

    
    <script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--javascript/init.combined.js"></script>
    <script  type="text/javascript">
        var URL_HOST = 'www.wikidot.com';
        var URL_DOMAIN = 'wikidot.com';
        var USE_SSL =  true ;
        var URL_STATIC = 'http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9';
        // global request information
        
        var WIKIREQUEST = {};
        WIKIREQUEST.info = {};
        
        WIKIREQUEST.info.domain = "250bpm.com";
        WIKIREQUEST.info.siteId = 148706;
        WIKIREQUEST.info.siteUnixName = "250bpm";
        WIKIREQUEST.info.categoryId = 2550760;
        WIKIREQUEST.info.themeId = 18520;
        WIKIREQUEST.info.requestPageName = "blog:70";
        OZONE.request.timestamp = 1594263556;
        OZONE.request.date = new Date();
        WIKIREQUEST.info.lang = 'en';
                WIKIREQUEST.info.pageUnixName = "blog:70";
        WIKIREQUEST.info.pageId = 34282904;
                        WIKIREQUEST.info.lang = "en";
        OZONE.lang = "en";
        var isUAMobile = !!/Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    </script>
    
    


    
        <script  type="text/javascript">
    
        require.config({
            baseUrl: URL_STATIC + '/common--javascript',
            paths: {
                'jquery.ui': 'jquery-ui.min',
                'jquery.form': 'jquery.form'
            }
        });
    
    </script>
    
    <meta http-equiv="content-type" content="text/html;charset=UTF-8"/>
            
    
    
    
    
    <meta http-equiv="content-language" content="en"/>
    <script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--javascript/WIKIDOT.combined.js"></script>
        
    
    <style type="text/css" id="internal-style">
        
        /* modules */
        
                
        /* theme */
                    @import url(http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--theme/base/css/style.css);
                    @import url(http://250bpm.wdfiles.com/local--theme/250bpm/style.css);
            </style>
    
        
        
        
    <link rel="shortcut icon" href="/local--favicon/favicon.gif"/>
    <link rel="icon" type="image/gif" href="/local--favicon/favicon.gif"/>
    
            <link rel="apple-touch-icon" href="/common--images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="/common--images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="/common--images/apple-touch-icon-114x114.png" />
        
        
            <link rel="alternate" type="application/wiki" title="Edit this page" href="javascript:WIKIDOT.page.listeners.editClick()"/>
    
        <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-18234656-1']);
        _gaq.push(['_setDomainName', 'none']);
        _gaq.push(['_setAllowLinker', true]);
        _gaq.push(['_trackPageview']);

        _gaq.push(['old._setAccount', 'UA-68540-5']);
        _gaq.push(['old._setDomainName', 'none']);
        _gaq.push(['old._setAllowLinker', true]);
        _gaq.push(['old._trackPageview']);

                _gaq.push(['userTracker._setAccount', 'UA-3207370-9']);
        _gaq.push(['userTracker._trackPageview']);
            </script>
    
    <script type="text/javascript">
        window.google_analytics_uacct = 'UA-18234656-1';
        window.google_analytics_domain_name = 'none';
    </script>
    
        <link rel="manifest" href="/onesignal/manifest.json" />
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" acync=""></script>
    <script>
        var OneSignal = window.OneSignal || [];
        OneSignal.push(function() {
          OneSignal.init({
            appId: null,
          });
        });
    </script>
        
<link rel="alternate" type="application/rss+xml" title="Comments for the page &quot;Getting rid of state machines (II)&quot;" href="/feed/page/comments-34282904.xml"/><script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--modules/js/forum/ForumCommentsModule.js"></script>
<script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--modules/js/forum/ForumViewThreadModule.js"></script>
<script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--modules/js/forum/ForumViewThreadPostsModule.js"></script>
<script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--modules/js/forum/sub/ForumNewPostFormModule.js"></script>
</head>
<body id="html-body">
<div id="skrollr-body">
<a name="page-top"></a>





<div id="container-wrap-wrap">
    <div id="container-wrap">
        <div id="container">
            <div id="header">
              <h1><a href="/"><span>250bpm</span></a></h1>
                
                
                <!-- google_ad_section_start(weight=ignore) -->
                
                <div id="search-top-box" class="form-search">
    <form id="search-top-box-form" action="dummy" class="input-append">
        <input id="search-top-box-input" class="text empty search-query" type="text" size="15" name="query" value="Search this site" onfocus="if(YAHOO.util.Dom.hasClass(this, 'empty')){YAHOO.util.Dom.removeClass(this,'empty'); this.value='';}"/><input class="button btn" type="submit" name="search" value="Search"/>
    </form>
</div>
                
                
                    <div id="top-bar">
                        

<ul>
<li><a href="/">Home</a></li>
<li><a href="https://github.com/sustrik/cartesian">Cartesian</a></li>
<li><a href="http://libdill.org">Libdill</a></li>
<li><a href="http://nanomsg.org">Nanomsg</a></li>
<li><a href="https://github.com/sustrik/tiles">Tiles</a></li>
<li><a href="http://zero.mq">ZeroMQ</a></li>
<li><a href="/contact">Contact</a></li>
</ul>

                    </div>
                
                <div id="login-status"><a href="javascript:;" onclick="WIKIDOT.page.listeners.createAccount(event)" class="login-status-create-account btn">Create account</a> <span>or</span> <a href="javascript:;" onclick="WIKIDOT.page.listeners.loginClick(event)" class="login-status-sign-in btn btn-primary">Sign in</a> </div>
                <div id="header-extra-div-1"><span></span></div><div id="header-extra-div-2"><span></span></div><div id="header-extra-div-3"><span></span></div>
            </div>
            
            <div id="content-wrap">
                
                    <div id="side-bar">
                        


                        


                        


                    </div>
                
                
                <!-- google_ad_section_end -->
                
                <div id="main-content">
                    <div id="action-area-top"></div>
                    
                    
                        <div id="page-title">
                            Getting rid of state machines (II)
                        </div>
                    

                    

                    



                    <div id="page-content">
                        

<div style="width:50em"><div class="list-pages-box">    <div class="list-pages-item">


<p><strong>Previous:</strong> <a href="/blog:69">Getting rid of state machines (I)</a></p>
</div>
    
    
    
    </div><div class="list-pages-box">    <div class="list-pages-item">


<p><strong>Next:</strong> <a href="/blog:71">Structured Concurrency</a></p>
</div>
    
    
    
    </div>
<p>So, as explained in the previous article, with green threads every state machine can be rephrased as a simple imperative function.</p>
<p>Nice. So we are done, aren't we?</p>
<p>Well, kind of. It's useful to do a reality check though.</p>
<p>And it turns out that in the reality state machines have an unfortunate tendency to spontaneously emerge in the code that was never meant to be a state machine.</p>
<p>Here's an example in pseudo-Go (I am too lazy to try to compile it). This example gets events from two distinct sources, A and B and counts them:</p>
<div class="code">
<pre>
<code>func count(chanA chan string, chanB chan string) {
   sumA := 0
   sumB := 0
   for {
      select {
      case &lt;- chanA:
          sumA++
      case &lt;- chanB:
          sumB++
      }
   }
}</code>
</pre></div>
<p>Now imagine that communication with A becomes more complex. Let's say that the message from A is composed from a header and a body which are sent to the channel as two separate messages:</p>
<div class="code">
<pre>
<code>func count(chanA chan string, chanB chan string) {
   sumA := 0
   sumB := 0
   for {
      select {
      case &lt;- chanA:
          &lt;- chanA
          sumA++
      case &lt;- chanB:
          sumB++
      }
   }
}</code>
</pre></div>
<p>I assume you already see a problem with that: Receiving the body may block for unlimited amount of time. While it is blocked, no messages from B can be processed.</p>
<p>And here's a fix:</p>
<div class="code">
<pre>
<code>func count(chanA chan string, chanB chan string) {
   sumA := 0
   sumB := 0
   hasHeader boolean := false
   for {
      select {
      case &lt;- chanA:
          if !hasHeader {
              &lt;- chanA
              hasHeader = true
          }
          else {
              sumA++
              hasHeader = false
          }
      case &lt;- chanB:
          sumB++
      }
   }
}</code>
</pre></div>
<p>Do you see the state machine? If has a single bit of state (hasHeader) and two steps. The code is slightly ugly but it takes only a little bit more complexity in interaction with A or B to morph it into something really, really hideous.</p>
<p>What we see here is one state machine expressed as a goroutine (entire 'count' function) and another, hand-written and barely visible state machine that receives pair of messages from A. The two are tightly interwoven which is what makes the code look bad.</p>
<p>And of course, there's an easy solution. Just rip out the implicit state machine and turn it into a separate goroutine:</p>
<div class="code">
<pre>
<code>func messageParser(chanIn chan string, chanOut chan string) {
   for {
        &lt;- chanIn
        &lt;- chanIn
        chanOut &lt;- &quot;message&quot;
   }
}

func count(chanA chan string, chanB chan string) {
   chanParser := make(chan string)
   go messageParser(chanA, chanParser)
   sumA := 0
   sumB := 0
   hasHeader boolean := false
   for {
      select {
      case &lt;- chanParser:
          sumA++
      case &lt;- chanB:
          sumB++
      }
   }
}</code>
</pre></div>
<p>It would be nice if this technique was completely generic. In other words, if meticulous effort to split any interwoven state into separate green threads would result in a code with no overt or hidden state machines.</p>
<p>Unfortunately, that's not the case.</p>
<p>Specifically, this technique doesn't work when canceling green threads. Imagine that one of the channels in the example is used to cancel the goroutine:</p>
<div class="code">
<pre>
<code>func count(chanA chan string, chanB chan string) {
   sumA := 0
   for {
      select {
      case &lt;- chanA:
          sumA++
      case &lt;- chanB:
          return
      }
   }
}</code>
</pre></div>
<p>You can split handling of chanB into a separate goroutine, but that would mean that original goroutine will never get canceled! If you add cancellation mechanism to it, you are back to step one. Uh, oh.</p>
<p>Now I am going to make a strong claim based only on intuition, not on any theoretical insight. I believe it to be true but feel free to attack it (and don't forget to bring counterexamples with you):</p>
<p>&quot;If a language has efficient green threads and built in support for cancellation, every program can be decomposed into set of simple functions containing no implicit or explicit state machines.&quot;</p>
<p>To be clear, the built in cancellation mechanism must support wide array of use cases:</p>
<ol>
<li>Cancel entire program leaving no resource leaks behind.</li>
<li>Cancel a subsystem without any leaks.</li>
<li>Cancel a subsystem when a timeout expires. No leaks.</li>
<li>Give subsystem a grace period to finish its work before canceling it.</li>
<li>Grace period should be omitted if the subsystem has no work to do anyway.</li>
<li>Allow for interwoven cancellation when cancellation of a supersystem happens while cancellation of a subsystem is in progress.</li>
</ol>
<p>If the cancellation mechanism is not this generic users would have to implement these use cases by hand which will in turn lead to introduction of state machines into the code.</p>
<p>I've been trying to design such a cancellation mechanism for several years and I have repeatedly failed. Finally, I believe I have a solution that may work. I am going to describe it in the next article.</p>
<p><strong>Martin Sústrik, January 25th, 2016</strong></p>
<div class="list-pages-box">    <div class="list-pages-item">


<p><strong>Previous:</strong> <a href="/blog:69">Getting rid of state machines (I)</a></p>
</div>
    
    
    
    </div><div class="list-pages-box">    <div class="list-pages-item">


<p><strong>Next:</strong> <a href="/blog:71">Structured Concurrency</a></p>
</div>
    
    
    
    </div>
<div style="height:2em"></div>
<div class="comments-box">
		
	<div class="options" id="comments-options-hidden" style="display: none">
		<a href="javascript:;" onclick="WIKIDOT.modules.ForumCommentsModule.listeners.showComments(event)">Show Comments</a> 
	</div>
		
	<div id="thread-container" class="thread-container" style="margin-top: 1em">
					


<script type="text/javascript">
	WIKIDOT.forumThreadId = 1568611;
</script>


	<div class="options" id="comments-options-shown">
		<a href="javascript:;" onclick="WIKIDOT.modules.ForumCommentsModule.listeners.hideComments(event)" class="btn btn-default btn-small btn-sm">Hide All Comments</a> 
		<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.unfoldAll(event)" class="btn btn-default btn-small btn-sm">Unfold All</a> 
		<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.foldAll(event)" class="btn btn-default btn-small btn-sm">Fold All</a>
	</div>

<div id="thread-container-posts" style="display: none">
    



	
					
      
    <div class="post-container" id="fpc-2445648">
                      
		<div class="post" id="post-2445648">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,2445648)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-2445648">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=fe8e4742bbc96687699d22ead39cb05c&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Apostolis (guest)</span> <span class="odate time_1453754010 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">25 Jan 2016 20:33</span>
														</div>
			</div>
			<div class="content" id="post-content-2445648">
									

<p>I do not understand your problem of cancellation. I haven't worked with goroutines, maybe that is why.</p>
<p>If we look though at the introduction of the messageParser goroutine, I have some comments on it.</p>
<p>In the count function there are two code parts.</p>
<p>a) The first deals with the structure of the program itself. It creates a new goroutine and it passes the responsibility of a job. The first part has zero code on the logic itself. Not only that, if the dependencies are many and the structure is complicated, the code will be difficult to read.<br />
This is called spaggeti code. Spagetti code will arise because of the complexity of the problem itself, not the abilities of the programmer.<br />
The reason of the spaggeti code is that we are trying to write down in sequential mode, writing is sequencial, what is not sequential. The correct representation of the dependencies is a graph.</p>
<p>b) The second part deals with the logic.</p>
<p>The fact that those two types of code can coexist and even intermingle with each other is the worst nightmare one might have.</p>
<p>Secondly, there are two types of interdependencies.<br />
A) Those known at compile time. They are static, thus they do not change.<br />
B) Those that need to change dynamically as the program is executed.</p>
<p>For the first case, static analysis can show which parts of the code need to be executed asynchronously.<br />
Anything that has an external asynchronous input needs to be asynchronously executed from each other.</p>
<p>The second case is trickier because it requires to do what you do here with goroutines. You are transforming the structure of the program itself while you are executing code.<br />
For this case, I am still not sure what is the best way to do it. Certainly, a separation between logic and this code. Maybe there should be more restrictions.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,2445648)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,2445648)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-2445648" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,2445648)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,2445648)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=fe8e4742bbc96687699d22ead39cb05c&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Apostolis (guest)</span>, <span class="odate time_1453754010 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">25 Jan 2016 20:33</span>
		</div>
	</div>
 
                
                	


        
            </div>
 

	
					
      
    <div class="post-container" id="fpc-2445789">
                      
		<div class="post" id="post-2445789">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,2445789)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-2445789">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263556" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1453778320 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">26 Jan 2016 03:18</span>
														</div>
			</div>
			<div class="content" id="post-content-2445789">
									

<p>Here's the simplest possible exercise to demonstrate the problem:</p>
<p>Write a goroutine with two arguments, both of them being channels. If it gets a message (N bytes long) on the first channel it writes it to a TCP socket. If it gets a message on the second channel it terminates immediately. Take care to handle the case when there's pushback going on in the TCP socket.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,2445789)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,2445789)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-2445789" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,2445789)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,2445789)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263556" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1453778320 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">26 Jan 2016 03:18</span>
		</div>
	</div>
 
                
        
            </div>
 

	
					
      
    <div class="post-container" id="fpc-2445912">
                      
		<div class="post" id="post-2445912">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,2445912)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-2445912">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=fe8e4742bbc96687699d22ead39cb05c&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Apostolis (guest)</span> <span class="odate time_1453811656 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">26 Jan 2016 12:34</span>
														</div>
			</div>
			<div class="content" id="post-content-2445912">
									

<p>I wouldn't use two channels. I would use only one. And I would close the channel from the creator goroutine.<br />
Anything that is already sent to the channel will be processed. Immediately after, it will close.<br />
<a href="https://gobyexample.com/closing-channels">https://gobyexample.com/closing-channels</a></p>
<p>The main question is what you mean by immediately. In my solution, the goroutine immediately stops receiving new input but it processes all the input it received.</p>
<p>But as I said, I have no experience with goroutines.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,2445912)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,2445912)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-2445912" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,2445912)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,2445912)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=fe8e4742bbc96687699d22ead39cb05c&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Apostolis (guest)</span>, <span class="odate time_1453811656 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">26 Jan 2016 12:34</span>
		</div>
	</div>
 
                
        
                      
    <div class="post-container" id="fpc-2446000">
                      
		<div class="post" id="post-2446000">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,2446000)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-2446000">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=ccbe7da9a44a8737ca2eda4462c42fe1&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Martin Sustrik (guest)</span> <span class="odate time_1453822737 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">26 Jan 2016 15:38</span>
														</div>
			</div>
			<div class="content" id="post-content-2446000">
									

<p>In your solution a malevolent TCP peer could cause pushback which will in turn block the goroutine in send() function. The goroutine will never exit, creating a resource leak. The behaviour can be used to conduct a DoS attack.</p>
<p>The requirement is to close the goroutine immediately, not later on, when the send() succeeds.</p>
<p>Siliar situation happens when malevolent client opens a connection to server and doesn't send anything. If there's no cancelation mechanism, server will wait for protocol header indefinitely, leaking goroutine, file descriptor, memory et c.</p>

							</div>

								
							<div class="changes">
					Last edited on <span class="odate time_1453823016 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">26 Jan 2016 15:43</span>
					by <span class="printuser"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>
					<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.showHistory(event,2446000)"><i class="icon-plus"></i> Show more</a>
				</div>
				<div class="revisions" style="display: none"></div>
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,2446000)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,2446000)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-2446000" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,2446000)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,2446000)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=ccbe7da9a44a8737ca2eda4462c42fe1&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Martin Sustrik (guest)</span>, <span class="odate time_1453822737 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">26 Jan 2016 15:38</span>
		</div>
	</div>
 
                
        
                      
    <div class="post-container" id="fpc-2446108">
                      
		<div class="post" id="post-2446108">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,2446108)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-2446108">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=fe8e4742bbc96687699d22ead39cb05c&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Apostolis (guest)</span> <span class="odate time_1453834989 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">26 Jan 2016 19:03</span>
														</div>
			</div>
			<div class="content" id="post-content-2446108">
									

<p>Good point. So there needs to be an out of band cancellation mechanism.</p>
<p>What is of concern to me is how to revert changes that happened if one part of it needs to be cancelled.</p>
<p>If a state change has already been applied by part of the code and then one cancels the remaining process, we are left with inconsistent data.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,2446108)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-2446108" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,2446108)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,2446108)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=fe8e4742bbc96687699d22ead39cb05c&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Apostolis (guest)</span>, <span class="odate time_1453834989 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">26 Jan 2016 19:03</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-2446130">
                      
		<div class="post" id="post-2446130">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,2446130)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-2446130">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263556" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1453838277 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">26 Jan 2016 19:57</span>
														</div>
			</div>
			<div class="content" id="post-content-2446130">
									

<p>Exactly. I am going to cover the question of atomicity in the next post(s).</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,2446130)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,2446130)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-2446130" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,2446130)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,2446130)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263556" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1453838277 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">26 Jan 2016 19:57</span>
		</div>
	</div>
 
                
        
            </div>
 
            </div>
 
            </div>
 

	
					
      
    <div class="post-container" id="fpc-2469860">
                      
		<div class="post" id="post-2469860">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,2469860)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-2469860">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=899f61df2abe8772da2201fb0eaa7a09&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Yuchen (guest)</span> <span class="odate time_1457496622 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">09 Mar 2016 04:10</span>
														</div>
			</div>
			<div class="content" id="post-content-2469860">
									

<p>Thank you for the great topic.<br />
I assume there is an extra line &quot;&lt;- chanA&quot; below &quot;if !hasHeader {&quot;</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,2469860)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,2469860)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-2469860" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,2469860)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,2469860)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=899f61df2abe8772da2201fb0eaa7a09&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Yuchen (guest)</span>, <span class="odate time_1457496622 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">09 Mar 2016 04:10</span>
		</div>
	</div>
 
                
        
                      
    <div class="post-container" id="fpc-2469867">
                      
		<div class="post" id="post-2469867">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,2469867)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-2469867">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=ccbe7da9a44a8737ca2eda4462c42fe1&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Martin Sustrik (guest)</span> <span class="odate time_1457497037 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">09 Mar 2016 04:17</span>
														</div>
			</div>
			<div class="content" id="post-content-2469867">
									

<p>No need for it. The select statement itself reads the first part of the message.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,2469867)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,2469867)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-2469867" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,2469867)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,2469867)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=ccbe7da9a44a8737ca2eda4462c42fe1&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Martin Sustrik (guest)</span>, <span class="odate time_1457497037 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">09 Mar 2016 04:17</span>
		</div>
	</div>
 
                
        
                      
    <div class="post-container" id="fpc-2505398">
                      
		<div class="post" id="post-2505398">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,2505398)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-2505398">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=89d5be6d6427a35c87c6b32f5b135312&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>ruslan (guest)</span> <span class="odate time_1462736122 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">08 May 2016 19:35</span>
														</div>
			</div>
			<div class="content" id="post-content-2505398">
									

<p>Martin, you need to delete the &lt;-chanA that is below if!isHeader</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,2505398)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,2505398)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-2505398" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,2505398)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,2505398)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=89d5be6d6427a35c87c6b32f5b135312&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>ruslan (guest)</span>, <span class="odate time_1462736122 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">08 May 2016 19:35</span>
		</div>
	</div>
 
                
        
            </div>
 
            </div>
 
            </div>
 

	
					
      
    <div class="post-container" id="fpc-4288715">
                      
		<div class="post" id="post-4288715">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4288715)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4288715">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=a810f700abf84eb71b2b4f051946ebf7&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Dan (guest)</span> <span class="odate time_1561278465 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">23 Jun 2019 08:27</span>
														</div>
			</div>
			<div class="content" id="post-content-4288715">
									

<p>Hi I think you should delete the &lt;-chanA inside !isHeader</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,4288715)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,4288715)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4288715" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4288715)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4288715)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=a810f700abf84eb71b2b4f051946ebf7&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Dan (guest)</span>, <span class="odate time_1561278465 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">23 Jun 2019 08:27</span>
		</div>
	</div>
 
                
        
            </div>
 



</div>

        <a href="javascript:;" id="new-post-button" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.newPost(event,null)"
      style="display:  none ; margin-bottom:1em"
    >Add a New Comment</a>


    <div id="new-post-form-container">
        <div id="new-post-preview-div" style="display: none">
            <h1>Post preview:</h1>
            <div class="post-container"></div>
            <div></div>
            <a href="javascript:;" onclick="WIKIDOT.modules.ForumNewPostFormModule.listeners.closePreview(event)" class="btn btn-danger">Close preview</a>
        </div>

        <div id="new-post-div" class="well">
            <form id="new-post-form" onkeypress="return OZONE.utils.disableEnterKey(event)">
                <input type="hidden" name="threadId" value="1568611"/>
                <input type="hidden" name="parentId" value=""/>
                                    <table class="guest-commenting">
                        <tr>
                            <td><input class="text form-control" name="guestName" type="text" maxlength="30" value="" title="Name"/></td>
                            <td>or <a href="#action:login">Sign in as Wikidot user</a></td>
                        </tr>
                        <tr>
                            <td><input class="text form-control" name="guestEmail" type="text" maxlength="50" value="" title="E-mail address"/></td>
                            <td>(will not be published)</td>
                        </tr>
                    </table>
                                <div><textarea id="np-text" name="source" rows="10" cols="50" class="form-control"></textarea></div>
                <div class="change-textarea-size">
                    <a href="javascript:;" onclick="WIKIDOT.utils.changeTextareaRowNo('np-text',-5)">-</a>
                    <a href="javascript:;" onclick="WIKIDOT.utils.changeTextareaRowNo('np-text',5)">+</a>
                </div>
                <div class="edit-help-34">
                    Help: <a href="http://www.wikidot.com/doc:quick-reference" target="_blank">wiki text quick reference</a>                </div>
                                
                <div id="edit-post-captcha"></div>
                
                <div class="buttons alignleft">
                    <input class="btn btn-danger btn-small btn-sm" type="button" value="Cancel" id="np-cancel" onclick="WIKIDOT.modules.ForumNewPostFormModule.listeners.cancel(event)"/>
                    <input class="btn btn-default btn-small btn-sm" type="button" value="Preview" id="np-preview" onclick="WIKIDOT.modules.ForumNewPostFormModule.listeners.preview(event)"/>
                    <input class="btn btn-primary btn-small btn-sm" type="button" value="Post it" id="np-post" onclick="WIKIDOT.modules.ForumNewPostFormModule.listeners.save(event)"/>
                </div>
                    
            </form>
        </div>	

    </div> 
            <script type="text/javascript">
            
            $j(function() {
                WIKIDOT.Editor.init("np-text", "np-editor-panel");
            });
            
        </script>
    
 

<div style="display:none" id="post-options-template">
	<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.showPermalink(event,'%POST_ID%')" class="btn btn-default btn-small btn-sm">Permanent Link</a>
			<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.editPost(event,'%POST_ID%')" class="btn btn-default btn-small btn-sm">Edit</a>
			<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.deletePost(event,'%POST_ID%')" class="btn btn-danger btn-small btn-sm">Delete</a>
</div>
	
			</div>
	
	
	
</div></div>

                    </div>

                    


                    



                    

                    <div id="page-info-break"></div>
                    
                        <div id="page-options-container">
                            
                        </div>
                    
                    <div id="action-area" style="display: none;"></div>
                </div>
            </div>
            
            
            
            <div id="footer" style="display: block; visibility: visible;">
                <div class="options" style="display: block; visibility: visible;">
    <a href="http://www.wikidot.com/doc" id="wikidot-help-button">Help</a>
    &nbsp;|
    <a href="http://www.wikidot.com/legal:terms-of-service" id="wikidot-tos-button">Terms of Service</a>
    &nbsp;|
    <a href="http://www.wikidot.com/legal:privacy-policy" id="wikidot-privacy-button">Privacy</a>
    &nbsp;|
    <a href="javascript:;" id="bug-report-button" onclick="WIKIDOT.page.listeners.pageBugReport(event)">Report a bug</a>
    &nbsp;|
    <a href="javascript:;" id="abuse-report-button" onclick="WIKIDOT.page.listeners.flagPageObjectionable(event)">Flag as objectionable</a>
</div>
Powered by <a href="http://www.wikidot.com">Wikidot.com</a> 
            </div>
            
                <div id="license-area" class="license-area">
                    Unless otherwise stated, the content of this page is licensed under <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 License</a>
                </div>
            
            
            



            <div id="extrac-div-1"><span></span></div><div id="extrac-div-2"><span></span></div><div id="extrac-div-3"><span></span></div>
            
            
            
            
                
            
        </div>
        
    </div>
<!-- These extra divs/spans may be used as catch-alls to add extra imagery. -->
<div id="extra-div-1"><span></span></div><div id="extra-div-2"><span></span></div><div id="extra-div-3"><span></span></div>
<div id="extra-div-4"><span></span></div><div id="extra-div-5"><span></span></div><div id="extra-div-6"><span></span></div>
</div>




</div>
<div id="dummy-ondomready-block" style="display: none;" ></div>
    <!-- Google Analytics load -->
    <script type="text/javascript">
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

    <!-- Quantcast -->
    <script type="text/javascript">
    _qoptions={
        qacct:"p-edL3gsnUjJzw-"
    };
    (function() {
        var qc = document.createElement('script'); qc.type = 'text/javascript'; qc.async = true;
        qc.src = ('https:' == document.location.protocol ? 'https://secure' : 'http://edge') + '.quantserve.com/quant.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(qc, s);
    })();
    </script>
    <noscript>
        <img src="http://pixel.quantserve.com/pixel/p-edL3gsnUjJzw-.gif" style="display: none;" border="0" height="1" width="1" alt="Quantcast"/>
    </noscript>




<div id="page-options-bottom-tips" style="display: none;">
    <div id="edit-button-hovertip">
        Click here to edit contents of this page.    </div>
</div>
<div id="page-options-bottom-2-tips"  style="display: none;">
    <div id="edit-sections-button-hovertip">
        Click here to toggle editing of individual sections of the page (if possible).         Watch headings for an &quot;edit&quot; link when available.    </div>
    <div id="edit-append-button-hovertip">
        Append content without editing the whole page source.    </div>
    <div id="history-button-hovertip">
        Check out how this page has evolved in the past.    </div>
    <div id="discuss-button-hovertip">
        If you want to discuss contents of this page - this is the easiest way to do it.    </div>
    <div id="files-button-hovertip">
        View and manage file attachments for this page.    </div>
    <div id="site-tools-button-hovertip">
        A few useful tools to manage this Site.    </div>
    <div id="backlinks-button-hovertip">
        See pages that link to and include this page.    </div>
    <div id="rename-move-button-hovertip">
        Change the name (also URL address, possibly the category) of the page.    </div>
    <div id="view-source-button-hovertip">
        View wiki source for this page without editing.    </div>
    <div id="parent-page-button-hovertip">  
        View/set parent page (used for creating breadcrumbs and structured layout).    </div>
            <div id="abuse-report-button-hovertip">
            Notify administrators if there is objectionable content in this page.        </div>
        <div id="bug-report-button-hovertip">
            Something does not work as expected? Find out what you can do.        </div>
        <div id="wikidot-help-button-hovertip">
            General Wikidot.com documentation and help section.        </div>
        <div id="wikidot-tos-button-hovertip">
            Wikidot.com Terms of Service - what you can, what you should not etc.        </div>
        <div id="wikidot-privacy-button-hovertip">
            Wikidot.com Privacy Policy.          
        </div>
    </div>
</body>
</html>