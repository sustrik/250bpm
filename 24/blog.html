<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
    <title>The Callback Hell - 250bpm</title>
    
    	<script type="text/javascript" src="http://www.wikidot.com/default__flow/login__CustomDomainScript?site_id=148706"></script>

    
    <script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--javascript/init.combined.js"></script>
    <script  type="text/javascript">
        var URL_HOST = 'www.wikidot.com';
        var URL_DOMAIN = 'wikidot.com';
        var USE_SSL =  true ;
        var URL_STATIC = 'http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9';
        // global request information
        
        var WIKIREQUEST = {};
        WIKIREQUEST.info = {};
        
        WIKIREQUEST.info.domain = "250bpm.com";
        WIKIREQUEST.info.siteId = 148706;
        WIKIREQUEST.info.siteUnixName = "250bpm";
        WIKIREQUEST.info.categoryId = 2550760;
        WIKIREQUEST.info.themeId = 18520;
        WIKIREQUEST.info.requestPageName = "blog:24";
        OZONE.request.timestamp = 1594263514;
        OZONE.request.date = new Date();
        WIKIREQUEST.info.lang = 'en';
                WIKIREQUEST.info.pageUnixName = "blog:24";
        WIKIREQUEST.info.pageId = 18102587;
                        WIKIREQUEST.info.lang = "en";
        OZONE.lang = "en";
        var isUAMobile = !!/Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    </script>
    
    


    
        <script  type="text/javascript">
    
        require.config({
            baseUrl: URL_STATIC + '/common--javascript',
            paths: {
                'jquery.ui': 'jquery-ui.min',
                'jquery.form': 'jquery.form'
            }
        });
    
    </script>
    
    <meta http-equiv="content-type" content="text/html;charset=UTF-8"/>
            
    
    
    
    
    <meta http-equiv="content-language" content="en"/>
    <script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--javascript/WIKIDOT.combined.js"></script>
        
    
    <style type="text/css" id="internal-style">
        
        /* modules */
        
                
        /* theme */
                    @import url(http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--theme/base/css/style.css);
                    @import url(http://250bpm.wdfiles.com/local--theme/250bpm/style.css);
            </style>
    
        
        
        
    <link rel="shortcut icon" href="/local--favicon/favicon.gif"/>
    <link rel="icon" type="image/gif" href="/local--favicon/favicon.gif"/>
    
            <link rel="apple-touch-icon" href="/common--images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="/common--images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="/common--images/apple-touch-icon-114x114.png" />
        
        
            <link rel="alternate" type="application/wiki" title="Edit this page" href="javascript:WIKIDOT.page.listeners.editClick()"/>
    
        <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-18234656-1']);
        _gaq.push(['_setDomainName', 'none']);
        _gaq.push(['_setAllowLinker', true]);
        _gaq.push(['_trackPageview']);

        _gaq.push(['old._setAccount', 'UA-68540-5']);
        _gaq.push(['old._setDomainName', 'none']);
        _gaq.push(['old._setAllowLinker', true]);
        _gaq.push(['old._trackPageview']);

                _gaq.push(['userTracker._setAccount', 'UA-3207370-9']);
        _gaq.push(['userTracker._trackPageview']);
            </script>
    
    <script type="text/javascript">
        window.google_analytics_uacct = 'UA-18234656-1';
        window.google_analytics_domain_name = 'none';
    </script>
    
        <link rel="manifest" href="/onesignal/manifest.json" />
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" acync=""></script>
    <script>
        var OneSignal = window.OneSignal || [];
        OneSignal.push(function() {
          OneSignal.init({
            appId: null,
          });
        });
    </script>
        
<link rel="alternate" type="application/rss+xml" title="Comments for the page &quot;The Callback Hell&quot;" href="/feed/page/comments-18102587.xml"/><script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--modules/js/forum/ForumCommentsModule.js"></script>
<script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--modules/js/forum/ForumViewThreadModule.js"></script>
<script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--modules/js/forum/ForumViewThreadPostsModule.js"></script>
<script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--modules/js/forum/sub/ForumNewPostFormModule.js"></script>
</head>
<body id="html-body">
<div id="skrollr-body">
<a name="page-top"></a>





<div id="container-wrap-wrap">
    <div id="container-wrap">
        <div id="container">
            <div id="header">
              <h1><a href="/"><span>250bpm</span></a></h1>
                
                
                <!-- google_ad_section_start(weight=ignore) -->
                
                <div id="search-top-box" class="form-search">
    <form id="search-top-box-form" action="dummy" class="input-append">
        <input id="search-top-box-input" class="text empty search-query" type="text" size="15" name="query" value="Search this site" onfocus="if(YAHOO.util.Dom.hasClass(this, 'empty')){YAHOO.util.Dom.removeClass(this,'empty'); this.value='';}"/><input class="button btn" type="submit" name="search" value="Search"/>
    </form>
</div>
                
                
                    <div id="top-bar">
                        

<ul>
<li><a href="/">Home</a></li>
<li><a href="https://github.com/sustrik/cartesian">Cartesian</a></li>
<li><a href="http://libdill.org">Libdill</a></li>
<li><a href="http://nanomsg.org">Nanomsg</a></li>
<li><a href="https://github.com/sustrik/tiles">Tiles</a></li>
<li><a href="http://zero.mq">ZeroMQ</a></li>
<li><a href="/contact">Contact</a></li>
</ul>

                    </div>
                
                <div id="login-status"><a href="javascript:;" onclick="WIKIDOT.page.listeners.createAccount(event)" class="login-status-create-account btn">Create account</a> <span>or</span> <a href="javascript:;" onclick="WIKIDOT.page.listeners.loginClick(event)" class="login-status-sign-in btn btn-primary">Sign in</a> </div>
                <div id="header-extra-div-1"><span></span></div><div id="header-extra-div-2"><span></span></div><div id="header-extra-div-3"><span></span></div>
            </div>
            
            <div id="content-wrap">
                
                    <div id="side-bar">
                        


                        


                        


                    </div>
                
                
                <!-- google_ad_section_end -->
                
                <div id="main-content">
                    <div id="action-area-top"></div>
                    
                    
                        <div id="page-title">
                            The Callback Hell
                        </div>
                    

                    

                    



                    <div id="page-content">
                        

<div style="width:50em"><div class="list-pages-box">    <div class="list-pages-item">


<p><strong>Previous:</strong> <a href="/blog:23">Getting Rid of ZeroMQ-style Contexts</a></p>
</div>
    
    
    
    </div><div class="list-pages-box">    <div class="list-pages-item">


<p><strong>Next:</strong> <a href="/blog:25">Event-driven architecture, state machines et al.</a></p>
</div>
    
    
    
    </div>
<p>I've spent last month re-writing the code of <a href="http://nanomsg.org">nanomsg</a> to use state machines internally, passing asynchronous events around instead of using random callbacks between the components. The change is complex, requires a lot of work and it is not visible to the end user, so the question is: Why do it at all? The time can be put to better use implementing sexy new features that would make the users happy. Instead, the progress on the library seems stalled and such major re-write may even result in regressions. Why even bother then?</p>
<p>I'll try to provide the answer in this article. It will introduce a generic argument against callbacks, so if you are using callbacks, give it a read even if you are not interested in nanomsg per se. By the way, note that I am not going to say anything new here. The knowledge has been around for literally decades. However, given the amount of callback-driven programming that's being done and apparent &#8212; although completely incomprehensible to me &#8212; craving of some users of ZeroMQ and nanomsg for callback-based APIs, I believe that re-iterating the basics would be useful.</p>
<p>The problem is that ZeroMQ codebase evolved to the point where the internal interactions within the library are so complex that adding any new core functionality have become virtually impossible. For example, while the library exists for 6 years there was no new transport mechanism added during that time. There were many attempts, but none have succeeded to provide a fully stable code that could be merged back to the mainline. Instead, people resort to writing bridges between ZeroMQ and other transports.</p>
<p>One of the goals of nanomsg was to improve the internal architecture of the library in such a way that adding new functionality would be easy. In the first iteration I've tried to avoid state machines once again (in some future article I'll try to explain why) and I've failed. The complexity have gradually crept back. It seems that the only way to keep the complexity at bay is to avoid callbacks.</p>
<p>Consider this code:</p>
<div class="code">
<pre>
<code>struct A
{
    void foo () {b-&gt;baz ();}
    void bar () {++i;}
    B *b;
    int i;
}

struct B
{
    void baz () {a-&gt;bar ();}
    A *a;
};</code>
</pre></div>
<p>It's pretty simple. A has pointer to B and vice versa. If you invoke A::foo, it will invoke B::baz which in turn will invoke A::bar. A::bar increments a member variable of A. There's no catch there. The program will work as expected.</p>
<div class="image-container aligncenter"><img src="http://www.250bpm.com/local--files/blog:24/callback0.png" alt="callback0.png" class="image" /></div>
<p>However, imagine we'll make A::foo a little bit more complex:</p>
<div class="code">
<pre>
<code>void A::foo ()
{
    int tmp = i;
    b-&gt;baz ();
    assert (tmp == i);
}</code>
</pre></div>
<p>We copy a class member variable into a local variable and invoke a function. Nothing wrong with that. However, right afterwards we'll do a sanity check and test whether the local variable still equals to the member variable. Surprisingly, it does not. The value of the member variable have mysteriously changed just because we've invoked method of a different object.</p>
<p>Of course, it's easy to spot what went wrong in this example. We can fix the problem in a simple way. For example, we can re-read the value of the member variable into the local variable after the call:</p>
<div class="code">
<pre>
<code>void A::foo ()
{
    int tmp = i;
    b-&gt;baz ();
    tmp = i;
    assert (tmp == i);
}</code>
</pre></div>
<p>Now the program works as expected. It looks like those pesky callbacks are not that hard to handle after all!</p>
<p>Well, not quite. In what follows I'll try to explain why the code above is a tarpit just waiting to eat you alive.</p>
<p>First, imagine the callback happens in a more complex setup. Object A calls object B, which calls object C, which calls object D, which calls object E, which in turn calls back to object A.</p>
<div class="image-container aligncenter"><img src="http://www.250bpm.com/local--files/blog:24/callback1.png" alt="callback1.png" class="image" /></div>
<p>It's pretty obvious that handling the callback is going to be much more complex in this case. The problem stems from the fact that when A invokes B, it has no idea that there, nested five levels deep, is a call back to A. Thus, when the call to B returns, the developer will be genuinely surprised that the state of A have mutated in the meantime.</p>
<p>If there was only a single call in each function, as shown on the picture above, i.e. call to B would be the only function invocation in A, call to C would be the only function invocation in B etc. spotting the cycle would be still possible. However, let's suppose that each function contains in average three function invocations. That means that down there, five levels deep, are 243 functions one of which may &#8212; or may not &#8212; be a call back to A. That kind of thing is extremely hard to spot just by looking at the code.</p>
<p>Furthermore, many of the functions in the call graph are invoked only when certain condition is met and some of those conditions are pretty rare. If the path from A back to A contains several rare conditions, the probabilities get multiplied and the callback will almost never happen. Thus, even with extensive testing it is entirely possible that the callback will never be triggered and the problem it causes will go through the testing unnoticed &#8212; only to occur in production, presumably at the worst possible moment.</p>
<p>Add to that that the callback cycles are often not 5, but 10 or 15 steps long. In such environment there is basically no way to make sure that the program will behave decently. The best thing you can do is to perform some testing, then ship the product, then fix the bugs reported by the users. Even then you can be pretty sure there are some very rare bugs still lurking in the codebase.</p>
<p>I am going to suppose that by now I've persuaded you that long cycles in the call graph are a really bad idea. So let's get back to our original example. A calls B which in turn calls back to A. It's the simplest possible case of callback. The cycle is immediately visible, the developer can carefuly tune it to work in all circumstances. He can document the cycle and put big WARNING comment before each function invocation so that no future maintainer of the codebase can accidentally overlook it. What can possibly go wrong?</p>
<p>The problem is that in any realistic scenario the call graph is much more complex that the simple two-node graph as shown at the top of this article. There are other functions called by A and B gets called from other functions as well:</p>
<div class="image-container aligncenter"><img src="http://www.250bpm.com/local--files/blog:24/callback2.png" alt="callback2.png" class="image" /></div>
<p>Now imagine that at some point in the future some random developer adds a call from C to D. He's not even aware of existence of A and B, let alone the cycle between them. However, the change introduces a new 6-node-long cycle:</p>
<div class="image-container aligncenter"><img src="http://www.250bpm.com/local--files/blog:24/callback3.png" alt="callback3.png" class="image" /></div>
<p>Suddenly, it may happen that component E makes call to B &#8212; which worked with no problems before &#8212; and finds its own state modified when the function returns. Which, of course, makes it fail, or, even worse, misbehave.</p>
<p>To understand the scale of the problem we've created consider this: Developer of C have made a local change to C. The change have interacted with the small cycle in a completely unrelated subsystem and created a big cycle, which in turn causes yet enother completely unrelated component (E) to fail. Now let's assume that developer of C, developer of A&amp;B and developer of E are three different people, maybe even working in different departments or &#8212; if 3rd party libraries are used &#8212; in different companies. Perfectly reasonable change done by the first developer interacts in a bad way with a code written 15 years ago by the second developer and results in bug reported to the third developer working for a different company in some distant country and not even speaking English. I would rather not be that in that guy's shoes.</p>
<p>The common way to deal with the problems caused by cycles in the call graph is to introduce a new class variable (&quot;executing&quot;) that is turned on when the object is already being used and turned off when it is not. By checking this variable the component can identify the case where there is a cycle on the call stack and handle the case appropriately.</p>
<p>What follows is a simple example of such code. <em>executing</em> and <em>i</em> are member variables of class <em>A</em>. If the function is called in cycle it does nothing. If there's no cycle it increments the variable <em>i</em>:</p>
<div class="code">
<pre>
<code>void A::foo ()
{
    if (executing)
        return;
    executing = true;
    ++i;
    executing = false;
}</code>
</pre></div>
<p>This approach can help to get rid of a particular bug, but it's a hacky solution that may cause even more troubles in the future. Imagine that the code is modified like this:</p>
<div class="code">
<pre>
<code>void A::foo ()
{
    if (executing) {
        delete this;
        return;
    }
    executing = true;
    b-&gt;bar ();
    executing = false;
}

void B::bar ()
{
    a-&gt;foo ();
}</code>
</pre></div>
<p>Can you spot the problem?</p>
<p>The program will fail trying to access invalid memory location when doing <em>executing=false</em>. We can't really touch the member because the object can change while we do the <em>b-&gt;bar()</em> call and the &quot;change&quot; can actually mean that it gets deallocated.</p>
<p>The only real solution here is to delay the callback. To simply make a note that it has to be executed and execute it later on when call to <em>A::foo()</em> exits. And that, of course, is the first step towards a full-blown state machine approach.</p>
<p>If you are interested in the topic, there's a lot of literature about state machines on the web as well as lot of tools that will help you with implementing them. I would also like to explore this matter further in this blog. Specifically, there are two questions I am interested in: First, why are the developers willing to jump through the hoops just to avoid using state machines? Second, are there any good rules of thumb (as opposed to actual software tools) that the developer should keep in mind when implementing a state machine?</p>
<p>Stay tuned.</p>
<p><strong>Martin SÃºstrik, May 28th, 2013</strong></p>
<div class="list-pages-box">    <div class="list-pages-item">


<p><strong>Previous:</strong> <a href="/blog:23">Getting Rid of ZeroMQ-style Contexts</a></p>
</div>
    
    
    
    </div><div class="list-pages-box">    <div class="list-pages-item">


<p><strong>Next:</strong> <a href="/blog:25">Event-driven architecture, state machines et al.</a></p>
</div>
    
    
    
    </div>
<div style="height:2em"></div>
<div class="comments-box">
		
	<div class="options" id="comments-options-hidden" style="display: none">
		<a href="javascript:;" onclick="WIKIDOT.modules.ForumCommentsModule.listeners.showComments(event)">Show Comments</a> 
	</div>
		
	<div id="thread-container" class="thread-container" style="margin-top: 1em">
					


<script type="text/javascript">
	WIKIDOT.forumThreadId = 656490;
</script>


	<div class="options" id="comments-options-shown">
		<a href="javascript:;" onclick="WIKIDOT.modules.ForumCommentsModule.listeners.hideComments(event)" class="btn btn-default btn-small btn-sm">Hide All Comments</a> 
		<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.unfoldAll(event)" class="btn btn-default btn-small btn-sm">Unfold All</a> 
		<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.foldAll(event)" class="btn btn-default btn-small btn-sm">Fold All</a>
	</div>

<div id="thread-container-posts" style="display: none">
    

<div class="pager"><span class="pager-no">page 1 of 2</span><span class="current">1</span><span class="target"><a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadPostsModule.listeners.updateList(2)">2</a></span><span class="target"><a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadPostsModule.listeners.updateList(2)">next &raquo;</a></span></div>

	
					
      
    <div class="post-container" id="fpc-1784845">
                      
		<div class="post" id="post-1784845">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1784845)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1784845">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=7ab49f706c6c8d1bf0538c618a4c9a42&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Pierre (guest)</span> <span class="odate time_1369753661 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 15:07</span>
														</div>
			</div>
			<div class="content" id="post-content-1784845">
									

<p>Very nice summary of callbacks' fallbacks!</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1784845)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1784845)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1784845" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1784845)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1784845)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=7ab49f706c6c8d1bf0538c618a4c9a42&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Pierre (guest)</span>, <span class="odate time_1369753661 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 15:07</span>
		</div>
	</div>
 
                
                	


        
                      
    <div class="post-container" id="fpc-1784863">
                      
		<div class="post" id="post-1784863">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1784863)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1784863">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1369755441 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 15:37</span>
														</div>
			</div>
			<div class="content" id="post-content-1784863">
									

<p>Thanks!</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1784863)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1784863)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1784863" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1784863)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1784863)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1369755441 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 15:37</span>
		</div>
	</div>
 
                
        
            </div>
 
            </div>
 

	
					
      
    <div class="post-container" id="fpc-1784877">
                      
		<div class="post" id="post-1784877">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1784877)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1784877">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span> <span class="odate time_1369757050 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 16:04</span>
														</div>
			</div>
			<div class="content" id="post-content-1784877">
									

<p>The reason why all those problem exists in the code you presented is because you are doing things <strong>after a callback</strong>.</p>
<div class="code">
<pre>
<code>void A::foo ()
{
    int tmp = i;
    b-&gt;foo ();
    assert (tmp == i); // Bad practice! There should be nothing here other than &quot;return&quot;.
};</code>
</pre></div>
<p>So you ask, how do I deal with cases when I <strong>do</strong> need to do something after a callback?<br />
<strong>Push it into a global LIFO callback queue</strong>! The LIFO queue is managed by the event loop, and the event loop gives the events in the LIFO queue maximum priority.</p>
<p>NOTE: I use some pseudo-callbacks in this code, real code would use std::function or similar mechanisms.</p>
<div class="code">
<pre>
<code>struct A {
    ...
    // Represents a queued (or not) callback. It can either be in &quot;pushed&quot; or &quot;not pushed&quot; state.
    LifoEvent after_foo_event;
    ...
};

void A::init () // or constructor if you can stand those
{
    // set up for calling our afterFooCallback method
    after_foo_event.init(this, &amp;A::afterFooCallback);
}

void A::deinit () // or destructor if you can stand those
{
    // de-queue the lifo event in case it was qeueued to prevent crash if A is destroyed from b-&gt;foo() callback!
    after_foo_event.deinit();
}

void A::foo ()
{
    int tmp = i;
    after_foo_event.push(); // push to LIFO event queue
    return b-&gt;foo (); // return immediately after callback
}

void A::afterFooCallback ()
{
    // HERE do what you need to do after b-&gt;foo() callback!
    // No state confusion. If the b-&gt;foo() callback changed the state of this object,
    // than this was handled by our own methods. From those methods we can even
    // unschedule this callback.
    // This includes B destroying A!
}</code>
</pre></div>
<p>Note that the LIFO nature of the queue ensures that the event we push before calling b-&gt;foo() is executed now only after the b-&gt;foo() callback itself, but after all the LIFO event that pushes, recursively. The LIFO queue can be viewed as some kind of secondary stack for callbacks. You can even do recursive callbacks via the LIFO queue without overflowing the stack.</p>
<p>If you want to know more about this pattern, check out my SO answer here <a href="http://stackoverflow.com/questions/10064229/c-force-stack-unwinding-inside-function/10065950#10065950">http://stackoverflow.com/questions/10064229/c-force-stack-unwinding-inside-function/10065950#10065950</a> . Also, please do note that I'm not just giving you theory here - I've used this pattern extensively in my software for years, with great results.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1784877)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1784877)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1784877" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1784877)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1784877)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span>, <span class="odate time_1369757050 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 16:04</span>
		</div>
	</div>
 
                
        
                      
    <div class="post-container" id="fpc-1784878">
                      
		<div class="post" id="post-1784878">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1784878)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1784878">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span> <span class="odate time_1369757144 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 16:05</span>
														</div>
			</div>
			<div class="content" id="post-content-1784878">
									

<p>Note: the LIFO is best implemented using a doubly linked list. Singly-linked-list or array won't suffice because sometimes we want to de-queue already pushed events.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1784878)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1784878)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1784878" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1784878)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1784878)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span>, <span class="odate time_1369757144 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 16:05</span>
		</div>
	</div>
 
                
        
                      
    <div class="post-container" id="fpc-1784929">
                      
		<div class="post" id="post-1784929">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1784929)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1784929">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1369762444 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 17:34</span>
														</div>
			</div>
			<div class="content" id="post-content-1784929">
									

<p>Yes. Event queue is the first step towards fully formalised state machines.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1784929)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1784929" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1784929)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1784929)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1369762444 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 17:34</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1784957">
                      
		<div class="post" id="post-1784957">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1784957)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1784957">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span> <span class="odate time_1369765940 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 18:32</span>
														</div>
			</div>
			<div class="content" id="post-content-1784957">
									

<p>I think you're misunderstanding my design pattern as some kind of formalism you need to deal with on top the problem you're solving. You don't need to prove any theorems or do anything else formal to use this pattern. The goal is event driven code that's easier to write and maintain, not an extra burden on development.</p>
<p>You can check out some of my code to get a better idea. This piece of code is especially simple:</p>
<p><a href="https://code.google.com/p/badvpn/source/browse/trunk/ncd/extra/BEventLock.c">https://code.google.com/p/badvpn/source/browse/trunk/ncd/extra/BEventLock.c</a></p>
<p>It implements an asynchronous &quot;lock&quot;. The BEventLock represents a resource, and the BEventLockJob represents an operation that requires exclusive access to a resource. The BEventLockJob_Wait() is called to request access. When access is granted, a callback is invoked. Access can either be granted immediately, or cam be delayed (put in a queue), depending on whether the resource is currently locked. In the former case, the invocation of the callback is is done by pushing to the LIFO (BPending_Set()) directly from _Wait(); in the latter, the pushing is done from BEventLockJob_Release() when the resource is released.</p>
<p>See how from the perspective of someone who wants to lock the resource it doesn't look any different. There's no return code indicating whether access was granted immediately or whether a wait is necessary. This avoids a lot of hard to reproduce bugs (in code that would be handling the &quot;need to wait&quot; return code, since that happens rarely).</p>
<p>And there's no formalism here, just nice and correct code ;) As far as formalism is concerned, the clear separation of event processing into individual LIFO events actually makes proofs about the behavior of code easier, whether they are formal or informal.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1784957)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1784957" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1784957)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1784957)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span>, <span class="odate time_1369765940 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 18:32</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1784958">
                      
		<div class="post" id="post-1784958">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1784958)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1784958">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1369766041 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 18:34</span>
														</div>
			</div>
			<div class="content" id="post-content-1784958">
									

<p>Out of interest, two questions:</p>
<p>1. Why LIFO? Traditionally FIFO is used for event queues.<br />
2. I've never seen de-queueing used in cases like this. Is there any systemic reason for having it there?</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1784958)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1784958" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1784958)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1784958)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1369766041 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 18:34</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1784962">
                      
		<div class="post" id="post-1784962">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1784962)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1784962">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1369766304 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 18:38</span>
														</div>
			</div>
			<div class="content" id="post-content-1784962">
									

<p>I guess we are both speaking about the same thing. You call it LIFO, I call it event queue. The goal is to keep individual &quot;steps&quot; in processing fully atomic.</p>
<p>I agree that using term &quot;state machine&quot; implies a bit more than an event queue, specifically, explicit state transition diagram, so forget about what I said about state machines and substitute term &quot;event queue&quot; instead.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1784962)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1784962" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1784962)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1784962)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1369766304 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 18:38</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1784974">
                      
		<div class="post" id="post-1784974">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1784974)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1784974">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span> <span class="odate time_1369767571 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 18:59</span>
														</div>
			</div>
			<div class="content" id="post-content-1784974">
									

<p>A LIFO because it provides useful guarantees about the order of event processing.</p>
<div class="code">
<pre>
<code>EventA {
    push EventAfterB;
    push EventB;
};
EventAfterB {
    print &quot;This happens not only after B, but also after C!&quot;;
};
EventB {
    push EventC;
};
EventC {
    print &quot;EventC&quot;;
};</code>
</pre></div>
<p>So if we start with EventA pushed, the event queue will change like that:</p>
<div class="code">
<pre>
<code>EventA
EventAfterB EventB
EventAfterB EventC
EventAfterB
[empty, event loop proceeds to poll()]</code>
</pre></div>
<p>You could claim that a LIFO is bad because you could get caught in an infinite loop of event processing and stop processing new events. That can certainly happen, but the same can happen if you &quot;just do things after calling callbacks&quot;, and it is your responsibility to write code that doesn't get caught in such loops (such as counting invocations where there is potential for infinite loops). The advantage of using the LIFO is that such a loop will not crash your program via stack overflow.</p>
<p>So the LIFO is basically just a safe replacement for the usual &quot;do something after calling a callback&quot;. Instead of doing it after the callback, you push it before the callback.</p>
<p>De-queuing is very useful when the callback does something that removes the need for the &quot;do after callback&quot; code to be called. The best use of it is when the callback destroys the object that is calling it, and the &quot;destructor&quot; of that object simply unqueues the callback (if it didn't, the program would crash when the queued call is called). And this is something you need to do quite often. For example, in a Client you have a Socket, and the Socket calls the Client to tell it that the connection broke, and the Client in turn destroys itself including the Socket (so Socket is being destroyed while it's calling to the Client).</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1784974)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1784974" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1784974)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1784974)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span>, <span class="odate time_1369767571 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 18:59</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1785011">
                      
		<div class="post" id="post-1785011">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1785011)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1785011">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span> <span class="odate time_1369771097 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 19:58</span>
														</div>
			</div>
			<div class="content" id="post-content-1785011">
									

<p>&quot;The program will fail trying to access invalid memory location when doing executing=false&quot;</p>
<p>Pretty much the problem I've mentioned above. In the delete, destructor would de-queue any pending LIFO events, preventing their execution and avoiding a crash.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1785011)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1785011" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1785011)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1785011)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span>, <span class="odate time_1369771097 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 19:58</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1785062">
                      
		<div class="post" id="post-1785062">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1785062)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1785062">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span> <span class="odate time_1369777385 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 21:43</span>
														</div>
			</div>
			<div class="content" id="post-content-1785062">
									

<p>&quot;To simply make a note that it has to be executed and execute it later on when call to A::foo() exits&quot;</p>
<p>This is the exact reason a LIFO is useful. Pushing A before calling B makes sure that A executes after B is done. There's no need to complicate with partial orders and a &quot;a full-blown state machine approach&quot;.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1785062)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1785062)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1785062" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1785062)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1785062)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span>, <span class="odate time_1369777385 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 21:43</span>
		</div>
	</div>
 
                
        
            </div>
 
            </div>
 
            </div>
 

	
					
      
    <div class="post-container" id="fpc-1784881">
                      
		<div class="post" id="post-1784881">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1784881)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1784881">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span> <span class="odate time_1369757404 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 16:10</span>
														</div>
			</div>
			<div class="content" id="post-content-1784881">
									

<p>Another thing I noticed about your examples is that the objects (A and B for instance) are coupled to each other. This coupling is one factor that makes the system harder to maintain. You can use runtime dispatch (std::function or virtual methods or function pointers) or C++ templates to decouple them (unless they really have to be coupled).</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1784881)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1784881)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1784881" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1784881)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1784881)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span>, <span class="odate time_1369757404 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 16:10</span>
		</div>
	</div>
 
                
        
                      
    <div class="post-container" id="fpc-1784930">
                      
		<div class="post" id="post-1784930">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1784930)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1784930">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1369762642 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 17:37</span>
														</div>
			</div>
			<div class="content" id="post-content-1784930">
									

<p>I beg to differ. With straight functions you can at least check what's going to happen when you invoke it. On the other hand, virtual functions being &quot;abstract&quot; in a sense, you have no idea what the call graph looks like, whether invoking the function can possibly result in a cycle etc.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1784930)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1784930)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1784930" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1784930)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1784930)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1369762642 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 17:37</span>
		</div>
	</div>
 
                
        
                      
    <div class="post-container" id="fpc-1784964">
                      
		<div class="post" id="post-1784964">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1784964)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1784964">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span> <span class="odate time_1369766426 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 18:40</span>
														</div>
			</div>
			<div class="content" id="post-content-1784964">
									

<p>That's one way to look at it. But I usually design software by breaking problems down into smaller ones, resulting in a &quot;dependency graph&quot; that is a tree. After you define what the behavior of a component needs to be, you can implement and verify it independently of components &quot;above&quot; it. If your dependency graph has cycles, it's harder to look at components in isolation.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1784964)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1784964" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1784964)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1784964)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span>, <span class="odate time_1369766426 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 18:40</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1784991">
                      
		<div class="post" id="post-1784991">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1784991)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1784991">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span> <span class="odate time_1369769110 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 19:25</span>
														</div>
			</div>
			<div class="content" id="post-content-1784991">
									

<p>Oh, and there's an affect directly relevant to the callback problem. If you have coupling all around your codebase, then the question &quot;will calling this callback call me back&quot; can indeed be a very hard one. But what if you fixed your coupling? Well, if you are the owner of the set of objects {A,B,C}, and you call into A, then you *know* only the callbacks you gave to A could be invoked in response. If B and C have nothing to do with A, they couldn't possibly call you back in response to you calling into A. Not so much if A, B and C were coupled deeply in the your circular dependency graph.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1784991)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1784991" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1784991)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1784991)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span>, <span class="odate time_1369769110 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 19:25</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1784997">
                      
		<div class="post" id="post-1784997">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1784997)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1784997">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span> <span class="odate time_1369769554 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 19:32</span>
														</div>
			</div>
			<div class="content" id="post-content-1784997">
									

<p>&quot;Now imagine that at some point in the future some random developer adds a call from C to D&quot;.</p>
<p>In a properly decoupled program you would first have to restructure the code a bit, because C <strong>has no way to access and doesn't know about D</strong>. The restructuring would very likely reveal the new circular calls.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1784997)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1784997" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1784997)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1784997)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span>, <span class="odate time_1369769554 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 19:32</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1785267">
                      
		<div class="post" id="post-1785267">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1785267)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1785267">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1369804549 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">29 May 2013 05:15</span>
														</div>
			</div>
			<div class="content" id="post-content-1785267">
									

<p>Is there any specific reason why do you think C won't know about D?</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1785267)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1785267" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1785267)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1785267)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1369804549 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">29 May 2013 05:15</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1785451">
                      
		<div class="post" id="post-1785451">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1785451)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1785451">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span> <span class="odate time_1369832233 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">29 May 2013 12:57</span>
														</div>
			</div>
			<div class="content" id="post-content-1785451">
									

<blockquote>
<p>Is there any specific reason why do you think C won't know about D?</p>
</blockquote>
<p>In your first call graph C doesn't ever communicate with D. The only way C communicates with other components is by being called by the component above it. So in a properly designed system, C would only be aware of this component above, and maybe not even that, if it doesn't need to call back to it.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1785451)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1785451" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1785451)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1785451)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span>, <span class="odate time_1369832233 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">29 May 2013 12:57</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1785457">
                      
		<div class="post" id="post-1785457">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1785457)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1785457">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span> <span class="odate time_1369832957 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">29 May 2013 13:09</span>
														</div>
			</div>
			<div class="content" id="post-content-1785457">
									

<p>Here we come to your previous problem about &quot;Contexts&quot;. If you turn objects (like D) into global state, that makes it much easier for C to get access to D, possibly going against the design. On the other hand if you always require a pointer to D in order to access it, the problem is more obvious, because C wouldn't have a pointer to D - it didn't need it, before someone had the idea to make it talk to D.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1785457)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1785457" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1785457)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1785457)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span>, <span class="odate time_1369832957 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">29 May 2013 13:09</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1786139">
                      
		<div class="post" id="post-1786139">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1786139)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1786139">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1369902461 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">30 May 2013 08:27</span>
														</div>
			</div>
			<div class="content" id="post-content-1786139">
									

<p>Right. Avoiding global state would help to some extent.</p>
<p>Still there is another problem: Any network stack is entered from two distinct directions. From above (user API, such as BSD sockets) and from below (network interrupts). In first case the call sequence is, say, TCP-&gt;IP-&gt;Ethernet. In the latter case it is Ethernet-&gt;IP-&gt;TCP. That in turn means that there's no way to create a simple one-directional hierarchy of references. Upper layer has to have pointer to the lower layer and vice versa.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1786139)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1786139" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1786139)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1786139)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1369902461 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">30 May 2013 08:27</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1786250">
                      
		<div class="post" id="post-1786250">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1786250)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1786250">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span> <span class="odate time_1369919315 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">30 May 2013 13:08</span>
														</div>
			</div>
			<div class="content" id="post-content-1786250">
									

<p>So what? In my (C) code, upper layer owns the lower layer (so it calls it directly), and lower layer has callbacks (function pointer) to the upper layer. It looks like this:</p>
<div class="code">
<pre>
<code>typedef struct Socket_s Socket;
typedef void (*Socket_recv_done_handler) (Socket *, size_t length);

struct Socket_s {
    Socket_recv_done_handler recv_done_handler;
    BPending done_pending; // LIFO event
    size_t read_size;
};

void Socket_Init (Socket *o, ..., Socket_recv_done_handler recv_done_handler)
{
    o-&gt;recv_done_handler = recv_done_handler;
    BPending_Init(&amp;o-&gt;done_pending, done_pending_handler);
}

void Socket_Free (Socket *o)
{
    BPending_Free(&amp;o-&gt;done_pending); // make sure LIFO event is unqueued
}

void Socket_StartRecv (Socket *o, char *dst, size_t max_length)
{
    ssize_t bytes = recv(... dst, max_length);
    if (bytes &lt; 0 &amp;&amp; (errno == EAGAIN || errno == EWOULDBLOCK) {
        // Request file descriptor notification with event loop.
        // Remember dst and max_length.
        return;
    }
    if (bytes &lt;= 0) {
        // Fatal error. Use the LIFO event mechanism to report it.
        // (in real code that would be another function pointer)
        return;
    }
    // We got some data right away.
    // Queue invocation of recv_done_handler via the LIFO mechanism
    o-&gt;read_size = bytes;
    BPending_Set(&amp;o-&gt;done_pending);
}

void done_pending_handler (BPending *done_pending)
{
    Socket *o = container_of(done_pending, Socket, done_pending);
    return o-&gt;recv_done_handler(o, o-&gt;read_size);
}</code>
</pre></div>
<p>The lower layer can't just do anything it wants - the only way it can communicate with the upper layer is via defined callbacks, and of course the invocation of the callbacks is subject to contracts. Here, the Socket is only allowed to call the recv_done_handler once after a StartRecv.</p>
<p>All my C code looks like that, and it's <strong>very</strong> maintainable.</p>
<p>P.S. when I said the upper layer calls the lower layer directly, not always. Sometimes thin interface classes using function pointers may be involved, such as a Read/Done interface as used here. Because sometimes you don't want to couple your code to a Socket, you want it to work with anything that can receive data.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1786250)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1786250" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1786250)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1786250)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span>, <span class="odate time_1369919315 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">30 May 2013 13:08</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1786252">
                      
		<div class="post" id="post-1786252">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1786252)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1786252">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span> <span class="odate time_1369919446 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">30 May 2013 13:10</span>
														</div>
			</div>
			<div class="content" id="post-content-1786252">
									

<p>The problem here is not the direction of function calls, there sure can be cycles in the call graph. What matters more from the design perspective is the dependency graph. My Client class knows about Socket, but the Socket doesn't really know anything about the Client other than the defined callbacks it has provided.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1786252)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1786252" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1786252)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1786252)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span>, <span class="odate time_1369919446 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">30 May 2013 13:10</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1786277">
                      
		<div class="post" id="post-1786277">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1786277)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1786277">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1369921307 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">30 May 2013 13:41</span>
														</div>
			</div>
			<div class="content" id="post-content-1786277">
									

<p>Yes. That's the correct and maintainable approach. But I wouldn't call it callback anymore. It's an event queue.</p>
<p>Depending on the complexity of problem, you may decide to stick with simple event queues, or move further towards fully formalised state machines.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1786277)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1786277" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1786277)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1786277)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1369921307 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">30 May 2013 13:41</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1786280">
                      
		<div class="post" id="post-1786280">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1786280)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1786280">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1369921513 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">30 May 2013 13:45</span>
														</div>
			</div>
			<div class="content" id="post-content-1786280">
									

<p>Btw, I don't know much about your solution, but it may be that using LIFO instead of FIFO and dequeuing events is in your case an alternative way to deal with the problems normally addressed by state machines.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1786280)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1786280)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1786280" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1786280)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1786280)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1369921513 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">30 May 2013 13:45</span>
		</div>
	</div>
 
                
        
            </div>
 
            </div>
 
            </div>
 

	
					
      
    <div class="post-container" id="fpc-1784933">
                      
		<div class="post" id="post-1784933">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1784933)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1784933">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=4556fdd5bcb566fe6eb8483b86da630f&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>nomosyn (guest)</span> <span class="odate time_1369763270 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 17:47</span>
														</div>
			</div>
			<div class="content" id="post-content-1784933">
									

<p>Hi Martin !</p>
<p>At the very beginning, you wrote :<br />
void A::foo ()<br />
{<br />
int tmp = i;<br />
b-&gt;foo ();<br />
assert (tmp == i);<br />
}</p>
<p>Shouldn't it be :<br />
void A::foo ()<br />
{<br />
int tmp = i;<br />
b-&gt;baz();<br />
assert (tmp == i);<br />
}</p>
<p>?</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1784933)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1784933)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1784933" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1784933)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1784933)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=4556fdd5bcb566fe6eb8483b86da630f&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>nomosyn (guest)</span>, <span class="odate time_1369763270 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 17:47</span>
		</div>
	</div>
 
                
        
                      
    <div class="post-container" id="fpc-1784956">
                      
		<div class="post" id="post-1784956">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1784956)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1784956">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1369765935 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 18:32</span>
														</div>
			</div>
			<div class="content" id="post-content-1784956">
									

<p>Oops! Fixed. Thanks for spotting it!</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1784956)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1784956)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1784956" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1784956)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1784956)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1369765935 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 18:32</span>
		</div>
	</div>
 
                
        
            </div>
 
            </div>
 

	
					
      
    <div class="post-container" id="fpc-1785015">
                      
		<div class="post" id="post-1785015">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1785015)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1785015">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=0de1f64c85de266c1e9cd66e3ceda133&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Maciej Sobczak (guest)</span> <span class="odate time_1369771287 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 20:01</span>
														</div>
			</div>
			<div class="content" id="post-content-1785015">
									

<p>I'm not convinced. You have started with a conclusion (callbacks are evil) and then you have shown some very contrived and unrealistic examples to prove that conclusion.<br />
In a more reasonable scenario there are no callbacks between peer components at the same level of the software stack, but they will rather exist across layers, which makes them easier to manage.<br />
Also, circularity can be approached in other ways than detection - you could <strong>anticipate</strong> it and execute the callback in the state where subsequent actions on the same component would be perfectly OK and even not distinguishable from first-level calls. This approach was taken in the <a href="http://www.inspirel.com/yami4">YAMI4 messaging library</a> and guess what? No bugs in this area since the beginning of the project. So - it can be done properly with proper design in place. There's no hell there.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1785015)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1785015)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1785015" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1785015)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1785015)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=0de1f64c85de266c1e9cd66e3ceda133&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Maciej Sobczak (guest)</span>, <span class="odate time_1369771287 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 20:01</span>
		</div>
	</div>
 
                
        
                      
    <div class="post-container" id="fpc-1785019">
                      
		<div class="post" id="post-1785019">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1785019)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1785019">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span> <span class="odate time_1369771638 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 20:07</span>
														</div>
			</div>
			<div class="content" id="post-content-1785019">
									

<p>That's pretty much my opinion when I mentioned that he should decouple the components. You should read my comment about the LIFO queue, it makes callbacks &quot;not distinguishable from first-level calls&quot; easier to implement.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1785019)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1785019)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1785019" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1785019)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1785019)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span>, <span class="odate time_1369771638 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 20:07</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1785268">
                      
		<div class="post" id="post-1785268">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1785268)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1785268">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1369804928 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">29 May 2013 05:22</span>
														</div>
			</div>
			<div class="content" id="post-content-1785268">
									

<p>The examples are short to make the post readable.</p>
<p>In the real world the problem happens when a single component in &quot;steered&quot; from multiple directions. Typical example is network stack. There are calls originating in the user-facing API and there are calls originating from interrupts by networking hardware. The former traverse the layers from top to bottom, the latter from bottom to top. Unless you keep the two call graphs completely separate its very easy to form cycles in such environment.</p>
<p>And yes, the solution you are proposing is an event queue delaying the execution of actions till it's safe to call them. Event queues are a principal components of state machine implementation.</p>

							</div>

								
							<div class="changes">
					Last edited on <span class="odate time_1369804950 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">29 May 2013 05:22</span>
					by <span class="printuser"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>
					<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.showHistory(event,1785268)"><i class="icon-plus"></i> Show more</a>
				</div>
				<div class="revisions" style="display: none"></div>
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1785268)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1785268)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1785268" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1785268)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1785268)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1369804928 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">29 May 2013 05:22</span>
		</div>
	</div>
 
                
        
            </div>
 
            </div>
 

	
					
      
    <div class="post-container" id="fpc-1785037">
                      
		<div class="post" id="post-1785037">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1785037)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1785037">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/pieterh" onclick="WIKIDOT.page.listeners.userInfo(99); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=99&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="pieterh" style="background-image:url(http://www.wikidot.com/userkarma.php?u=99)"/></a><a href="http://www.wikidot.com/user:info/pieterh" onclick="WIKIDOT.page.listeners.userInfo(99); return false;" >pieterh</a></span> <span class="odate time_1369773305 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 20:35</span>
														</div>
			</div>
			<div class="content" id="post-content-1785037">
									

<p>If you have to search for evidence like &quot;ZeroMQ doesn't make it easy to add transports&quot; as proof that callbacks are bad, your argument is broken. The difficulty in adding transports to libzmq stems from poor internal design from the start, resulting in lack of internal abstractions. This was the design you built in there from the very start. Callbacks may be involved but are not the cause. The cause was rather more profound, the notion that a tiny team could accurately predict the needs of a widely-used product.</p>
<p>It is most certainly not due to increasing technical debt. The libzmq engine is getting cleaner and more extensible over time, not worse. For example it now supports multiple protocol versions very nicely.</p>
<p>I agree that callbacks are a pain but you should not use broken argumentation, it doesn't help your overall thesis. Also if you step aside from the &quot;ZeroMQ is crap and Nano is fantastic&quot; theme that seems to drive your thinking, and consider where the design problems in ZeroMQ actually came from (your vision of engineering, largely), you might realize how to save Nano from being an interesting experiment that finally, no-one really uses. I'm surely not the only person who wants Nano to succeed.</p>

							</div>

										<div class="signature">
					<hr class="signature-separator"/>
					

<p><a href="http://ipocracy.wikidot.com/main:portfolio">Portfolio</a></p>

				</div>
					
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1785037)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1785037)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1785037" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1785037)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1785037)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/pieterh" onclick="WIKIDOT.page.listeners.userInfo(99); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=99&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="pieterh" style="background-image:url(http://www.wikidot.com/userkarma.php?u=99)"/></a><a href="http://www.wikidot.com/user:info/pieterh" onclick="WIKIDOT.page.listeners.userInfo(99); return false;" >pieterh</a></span>, <span class="odate time_1369773305 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">28 May 2013 20:35</span>
		</div>
	</div>
 
                
        
                      
    <div class="post-container" id="fpc-1785282">
                      
		<div class="post" id="post-1785282">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1785282)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1785282">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1369805687 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">29 May 2013 05:34</span>
														</div>
			</div>
			<div class="content" id="post-content-1785282">
									

<p>What's wrong with the argument? Callbacks cause local changes to have global repercussions. Which is a maintenance nightmare. In the end they are pretty similar to using gotos. I guess Dijkstra explained the problem better than I did.</p>
<p>BTW, your experience with OpenAMQ would be valuable in this context. What are the problems of state-machine-based approach? Can they be solved by introducing callbacks? Etc.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1785282)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1785282)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1785282" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1785282)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1785282)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1369805687 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">29 May 2013 05:34</span>
		</div>
	</div>
 
                
        
                      
    <div class="post-container" id="fpc-1785292">
                      
		<div class="post" id="post-1785292">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1785292)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1785292">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/pieterh" onclick="WIKIDOT.page.listeners.userInfo(99); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=99&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="pieterh" style="background-image:url(http://www.wikidot.com/userkarma.php?u=99)"/></a><a href="http://www.wikidot.com/user:info/pieterh" onclick="WIKIDOT.page.listeners.userInfo(99); return false;" >pieterh</a></span> <span class="odate time_1369806766 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">29 May 2013 05:52</span>
														</div>
			</div>
			<div class="content" id="post-content-1785292">
									

<p>Your argument was (unless I misunderstood) that callbacks caused technical debt, i.e. a build up of bad code, in libzmq that made it impossible to extend six years later. Whereas in fact adding transports was hard from day one, due to the lack of internal abstractions (i.e. internal APIs designed to be extended).</p>
<p>Callbacks can be entirely local, this is how CZMQ/zreactor works (passing object instances around). The resulting code is easier to maintain in some ways but harder to understand because it's fractured.</p>
<p>State machines can provide extreme leverage, but are poorly implemented by most people. And even when well implemented they create a barrier to entry that is the real problem. You can win on engineering but lose on participation. OpenAMQ was a prime case of this.</p>
<p>If you look at how we used e.g. tools like Libero in the past you will see very clean, ultra-maintainable code, all callback based. I've used the same style in FileMQ, partly to show how to use state machines in protocol engines. But it's only maintainable once you've learned the model, and that's a barrier.</p>
<p>Perhaps it's safe to say that callbacks in general lead to arbitrary one-off abstractions that are very hard to learn. It was the same problem with GOTOs. Nothing to do with local vs. global. GOTOs let you create arbitrary structures that follow no patterns at all. Replacing them with WHILE, IF, DO meant we could learn a small fixed set of patterns instead.</p>

							</div>

										<div class="signature">
					<hr class="signature-separator"/>
					

<p><a href="http://ipocracy.wikidot.com/main:portfolio">Portfolio</a></p>

				</div>
					
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1785292)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1785292" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1785292)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1785292)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/pieterh" onclick="WIKIDOT.page.listeners.userInfo(99); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=99&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="pieterh" style="background-image:url(http://www.wikidot.com/userkarma.php?u=99)"/></a><a href="http://www.wikidot.com/user:info/pieterh" onclick="WIKIDOT.page.listeners.userInfo(99); return false;" >pieterh</a></span>, <span class="odate time_1369806766 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">29 May 2013 05:52</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1786137">
                      
		<div class="post" id="post-1786137">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1786137)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1786137">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1369902024 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">30 May 2013 08:20</span>
														</div>
			</div>
			<div class="content" id="post-content-1786137">
									

<p>The callbacks were there from the day one. Interestingly, I've opted for callbacks because of the barrier to entry we've experienced with OpenAMQ. However, it seems that avoiding state machines altogether is not a good option either. There must be some kind of middle ground. What I was thinking about was that instead of using a special language for state machines (ragel, libero, mbeddr, etc.) just explicitly documenting small set of rules that the state machines have to adhere to. Anyway, it's hard to say in advance what kind of compromise would work the best.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1786137)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1786137" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1786137)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1786137)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1369902024 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">30 May 2013 08:20</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1800112">
                      
		<div class="post" id="post-1800112">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1800112)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1800112">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=6978d9d53c53e915c5578aaff5158548&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>mike (guest)</span> <span class="odate time_1371654312 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">19 Jun 2013 15:05</span>
														</div>
			</div>
			<div class="content" id="post-content-1800112">
									

<p>Perhaps part of the barrier to entry with OpenAMQ was the XML/C DSL and code generation it uses, not sure at what version this started, but it looks like it's always used a DSL+CodeGenerator, possibly Libero.</p>
<p>Are you considering a code generator for nanomsg or a spec/api for the state machine?</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1800112)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1800112" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1800112)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1800112)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=6978d9d53c53e915c5578aaff5158548&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>mike (guest)</span>, <span class="odate time_1371654312 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">19 Jun 2013 15:05</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1800376">
                      
		<div class="post" id="post-1800376">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1800376)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1800376">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1371670363 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">19 Jun 2013 19:32</span>
														</div>
			</div>
			<div class="content" id="post-content-1800376">
									

<p>I've already written it by hand &#8212; i.e. no code generation.</p>
<p>Although it means a lot of boilerplate code in the codebase (yuck!), on the other hand it allows any developer to peek directly at the source code and understand what's going on without to learn a new language.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1800376)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1800376" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1800376)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1800376)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1371670363 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">19 Jun 2013 19:32</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1800763">
                      
		<div class="post" id="post-1800763">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1800763)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1800763">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=6978d9d53c53e915c5578aaff5158548&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>mike (guest)</span> <span class="odate time_1371734959 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Jun 2013 13:29</span>
														</div>
			</div>
			<div class="content" id="post-content-1800763">
									

<p>I took a look at the state machine in cipc.c on the aio2 branch it's very clean and easy to understand the transitions. I prefer the boilerplate to code-gen or macros any day.</p>
<p>One thing I did find a little confusing was the nested &quot;switch (type)&quot; it looks like type is the state of another state machine, &quot;switch (sock-&gt;state)&quot;.</p>
<p>There is also the possibility of using a state transition table and/or function lookup tables to remove some of the boiler plate. With this approach your default: handles all the common cases, like make a call and sets the next state and more complex cases get their own case statement &quot;case NN_COMPLICATED_STATE:&quot;. If you can make the lookup arrays easy to read and maintain this could be a win. You could even case the boilerplate states and let them all fall through to the boilerplate lookup-&gt;call-&gt;set case and still maintain the default state for trapping invalid states. Lookup tables can also eliminate a lot of branching.</p>
<p>In even more complex state transitions a stack can be used to pass information between nested states, not sure that applies here, but it's useful in lex/parse.</p>
<p>Another nice advantage to the state machine approach is debugging, just log the states or even keep the last n states in a ring buffer.</p>
<p>I don't see any barrier to entry here, all the states and transitions are clearly defined in a hundred lines of very readable code. If you need any clarification, email or reply. I've have built quite a few DFSMs.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1800763)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1800763" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1800763)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1800763)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=6978d9d53c53e915c5578aaff5158548&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>mike (guest)</span>, <span class="odate time_1371734959 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Jun 2013 13:29</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1800832">
                      
		<div class="post" id="post-1800832">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1800832)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1800832">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1371743353 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Jun 2013 15:49</span>
														</div>
			</div>
			<div class="content" id="post-content-1800832">
									

<p>Several good points here. Let me comment on them one by one.</p>
<p>I don't feel good about name 'type' myself. It's not another state. It's the type of the event being processed. So, a single source object can emit different kind of events, say a socket can emit SENT and RECEIVED events. 'type' argument is used to distinguish between the two. Suggestions for better fitting name are welcome.</p>
<p>As for state transition tables I have deliberately not used them. The rationale is the same as the rationale for not using code generation: State transitions tables make the code very hard to follow. Instead, I've opted for a single transition function with three nested levels of switches (in this order): the state, the source of the event, the type of the event. That makes it relatively easy to find your way through the state machine be simply scrolling the source code up and down.</p>
<p>As for nested state machines, I actually use them. For example, when cipc state machine is in ACTIVE state it handles the execution to sipc sub-state-machine. When sipc state machine terminates it hands the execution back to the cipc state machine. The same trick can be applied recursively, getting an arbitrary stack depth.</p>
<p>The debug log is a pretty neat idea. It would be worth of implementing, I guess.</p>
<p>Great to hear you don't see any barrier to entry. That's what I was trying to achieve. Typically, when code generation or macros are used, people feel there's an barrier to overcome.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1800832)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1800832" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1800832)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1800832)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1371743353 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Jun 2013 15:49</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1800951">
                      
		<div class="post" id="post-1800951">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1800951)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1800951">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=6978d9d53c53e915c5578aaff5158548&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>mike (guest)</span> <span class="odate time_1371752490 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Jun 2013 18:21</span>
														</div>
			</div>
			<div class="content" id="post-content-1800951">
									

<p>A source (usock) initiates an event (NN_USOCK_CONNECTED) on the target (cipc). The target state machine looks at the current state, looks at the source of the event and then acts on a valid event. target-&gt;state-&gt;source-&gt;event</p>
<p>If this is correct you might consider a convention such as NN_USOCK_EVENT_CONNECTED, and it might even be useful distinguish between an action and event where an action ACTION_CONNECT is initiated and EVENT_CONNECTED moves the machine into STATE_CONNECTED, action and event would still reside at the same level in the state machine.</p>
<div class="code">
<pre>
<code>    case NN_CIPC_STATE_CONNECTING:
        if (source == &amp;cipc-&gt;usock) {
            switch (type) {
            case NN_USOCK_CONNECTED:
                nn_sipc_start (&amp;cipc-&gt;sipc, &amp;cipc-&gt;usock);
                cipc-&gt;state = NN_CIPC_STATE_ACTIVE;
                return;
            case NN_USOCK_ERROR:
                nn_usock_stop (&amp;cipc-&gt;usock);
                cipc-&gt;state = NN_CIPC_STATE_STOPPING_USOCK;
                return;
            default:
                nn_assert (0);
            }
        }
        nn_assert (0);</code>
</pre></div>
<p>Regarding the nested state machines:</p>
<blockquote>
<p>For example, when cipc state machine is in ACTIVE state it hands the execution to sipc sub-state-machine.</p>
</blockquote>
<p>I could not find the hand off in cipc.cs NN_CIPC_STATE_ACTIVE, can you point me to src?</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1800951)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1800951" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1800951)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1800951)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=6978d9d53c53e915c5578aaff5158548&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>mike (guest)</span>, <span class="odate time_1371752490 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Jun 2013 18:21</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1800962">
                      
		<div class="post" id="post-1800962">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1800962)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1800962">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1371754596 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Jun 2013 18:56</span>
														</div>
			</div>
			<div class="content" id="post-content-1800962">
									

<p>Good suggestion about distinguishing the events and the actions. Currently, events have no specific prefix and actions have, confusingly, prefix _EVENT_. Let me fix that.</p>
<p>As for handing of the control from cipc to sipc it's done here:</p>
<p>nn_sipc_start (&amp;cipc-&gt;sipc, &amp;cipc-&gt;usock);</p>
<p>What happens is that sipc object takes ownership of the usock object and redirects any events from it to itself. When the connection breaks, it hands ownership of the usock back to cipc object.</p>
<p>One unrelated thought: I am considering passing adding one parameter to the handler function. Currently it is (target,source_ptr, event_type). I am thinking of extending it to (target, source_type, source_ptr, event_type). The problem it solves is when the state machine owns an unlimited number of source objects, for example, a list of sockets. In such case checking that source_ptr is one of the objects in the list would require list traversal (O(n) operation). Any thoughts about that?</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1800962)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1800962" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1800962)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1800962)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1371754596 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Jun 2013 18:56</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1801310">
                      
		<div class="post" id="post-1801310">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1801310)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1801310">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span> <span class="odate time_1371798648 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Jun 2013 07:10</span>
														</div>
			</div>
			<div class="content" id="post-content-1801310">
									

<p>Martin, why does the concept of a FSM exist in your code at all? For examole, in cipc.c, you do nn_fsm_init_root and pass nn_cipc_handler to that, and by passing that to other init's you set up nn_cipc_handler to handle events from three different sources. Why not just have three callback functions, what benefit does this indirection provide?</p>
<p>Even more, I would use different handlers for different event types, instead of using just one handler per event source. This way you can add event-specific arguments to the handler.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1801310)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1801310" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1801310)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1801310)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span>, <span class="odate time_1371798648 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Jun 2013 07:10</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1801486">
                      
		<div class="post" id="post-1801486">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1801486)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1801486">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=6978d9d53c53e915c5578aaff5158548&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>mike (guest)</span> <span class="odate time_1371828426 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Jun 2013 15:27</span>
														</div>
			</div>
			<div class="content" id="post-content-1801486">
									

<p>Regarding adding source_type, without knowing more about the number of source_types and if they could be organized into groups based on behavior. Here are some thoughts&#8230;</p>
<p>Reserve a few bytes at the beginning of the source object, the owner could then attach the type once before the state machine executes. This could also be used for other data such as the owner setting a flag on the source.</p>
<p>Create a state machine for a single type in the O(n) cases and have the source call into the handler for that machine, for example nn_cipc_handler_spic(&#8230;). If possible it would be nice eliminate the need for &quot;if (source == &amp;cipc-&gt;sipc)&quot; without over complicating the state machine.</p>
<p>If source_type cannot be avoided and the owner cannot write to the source object even one time during the wiring/initialization phase, consider some type of context object that the owner hands to the source that the source must pass with each handler call, that context object could contain the source_type, source_ptr etc.</p>
<p>Reserving a few bytes in the source seems the most appealing, you could have an issue where a source object might have more than one owner, then you would have to consider how many owners a source object could have, but I could still see this being workable.</p>
<p>If you can explain why some of these options won't work it might provide some more insight.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1801486)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1801486" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1801486)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1801486)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=6978d9d53c53e915c5578aaff5158548&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>mike (guest)</span>, <span class="odate time_1371828426 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Jun 2013 15:27</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1801776">
                      
		<div class="post" id="post-1801776">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1801776)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1801776">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1371853205 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Jun 2013 22:20</span>
														</div>
			</div>
			<div class="content" id="post-content-1801776">
									

<p>@Ambroz: The reason is to keep the hierarchy of the handler this way: state=&gt;source=&gt;event_type.</p>
<p>If you have different handler functions for different events the code will be structured (presumably) like this: event_type=&gt;source=&gt;state. That kind of code is extremely hard to follow.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1801776)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1801776" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1801776)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1801776)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1371853205 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Jun 2013 22:20</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1801789">
                      
		<div class="post" id="post-1801789">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1801789)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1801789">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1371855317 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Jun 2013 22:55</span>
														</div>
			</div>
			<div class="content" id="post-content-1801789">
									

<p>@mike: As for nn_cipc_handler_spic(â¦) I don;t like it for the same reason stated above: Having multiple handlers make code hard to follow (i.e. code belonging to a single state is suddenly scattered among different places in the source file.</p>
<p>&quot;Reserving the few bytes&quot; thing seems more resonable. I thought of just reserving a single integer. You would initialise it when intialising the source and get it back once the source fires an event.</p>
<p>For example:</p>
<p>nn_timer_init (&amp;self-&gt;retry_timer, NN_REQ_RETRY_TIMER);</p>
<p>And then, in the handler:</p>
<p>if (source_type == NN_REQ_RETRY_TIMER &amp;&amp; event_type == NN_TIMER_TIMEOUT) {<br />
timer = (struct nn_timer*) source;<br />
&#8230;.<br />
}</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1801789)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1801789" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1801789)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1801789)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1371855317 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Jun 2013 22:55</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1801805">
                      
		<div class="post" id="post-1801805">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1801805)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1801805">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=6978d9d53c53e915c5578aaff5158548&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>mike (guest)</span> <span class="odate time_1371857377 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Jun 2013 23:29</span>
														</div>
			</div>
			<div class="content" id="post-content-1801805">
									

<p>Four bytes seems reasonable due to alignment, you could even just use for example one byte if there would never be more than 255 types, or two bytes ect, and still have a couple free bytes for edge cases or anything else.</p>
<p>I'm not familiar enough with the code base and how initialization works yet, so put another way, the requirement could be that the first four bytes of any object participating in the state machine belong to the owner so I think we are on the same page.</p>
<p>Can a source object ever have more than one owner?</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1801805)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1801805" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1801805)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1801805)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=6978d9d53c53e915c5578aaff5158548&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>mike (guest)</span>, <span class="odate time_1371857377 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Jun 2013 23:29</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1801980">
                      
		<div class="post" id="post-1801980">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1801980)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1801980">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=6978d9d53c53e915c5578aaff5158548&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>mike (guest)</span> <span class="odate time_1371881563 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">22 Jun 2013 06:12</span>
														</div>
			</div>
			<div class="content" id="post-content-1801980">
									

<p>Another option is to require all state machine objects to use a special allocator that over allocates allowing room for source_type and returns an offset pointer.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1801980)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1801980" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1801980)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1801980)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=6978d9d53c53e915c5578aaff5158548&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>mike (guest)</span>, <span class="odate time_1371881563 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">22 Jun 2013 06:12</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1802003">
                      
		<div class="post" id="post-1802003">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1802003)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1802003">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1371885865 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">22 Jun 2013 07:24</span>
														</div>
			</div>
			<div class="content" id="post-content-1802003">
									

<p>Sure. But there's already a base class for all state machines (nn_fsm). Storing the integer there seems to be a cleaner solution.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1802003)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1802003" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1802003)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1802003)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1371885865 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">22 Jun 2013 07:24</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1802015">
                      
		<div class="post" id="post-1802015">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1802015)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1802015">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1371888484 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">22 Jun 2013 08:08</span>
														</div>
			</div>
			<div class="content" id="post-content-1802015">
									

<blockquote>
<p>Can a source object ever have more than one owner?</p>
</blockquote>
<p>No. Not allowed.</p>
<p>It's actually pretty crucial requirement. The idea is to have objects arranged in a tree (thus one owner for each one). Then we have to ways of communication:</p>
<ol>
<li>Up the tree (direction from root to leaves): this is implemented as simple function calls</li>
<li>Down the tree (direction from leaves to root): this is implemented as state machine events</li>
</ol>
<p>That makes interactions between the components relatively easy to grasp. With mulitple owners (i.e. graph instead of tree) it would be much harder.</p>

							</div>

								
							<div class="changes">
					Last edited on <span class="odate time_1371888507 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">22 Jun 2013 08:08</span>
					by <span class="printuser"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>
					<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.showHistory(event,1802015)"><i class="icon-plus"></i> Show more</a>
				</div>
				<div class="revisions" style="display: none"></div>
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1802015)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1802015" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1802015)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1802015)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1371888484 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">22 Jun 2013 08:08</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1803527">
                      
		<div class="post" id="post-1803527">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1803527)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1803527">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=6978d9d53c53e915c5578aaff5158548&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>mike (guest)</span> <span class="odate time_1372107135 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">24 Jun 2013 20:52</span>
														</div>
			</div>
			<div class="content" id="post-content-1803527">
									

<p>That makes sense, thanks for the clarification, looking forward to the state machine alpha.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1803527)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1803527" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1803527)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1803527)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=6978d9d53c53e915c5578aaff5158548&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>mike (guest)</span>, <span class="odate time_1372107135 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">24 Jun 2013 20:52</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1803578">
                      
		<div class="post" id="post-1803578">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1803578)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1803578">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=6978d9d53c53e915c5578aaff5158548&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>mike (guest)</span> <span class="odate time_1372110831 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">24 Jun 2013 21:53</span>
														</div>
			</div>
			<div class="content" id="post-content-1803578">
									

<p>I was looking over some of the new state machine code and wanted to make a clarification on the naming. Keep in mind I'm not a network programmer so these might not be the best examples.</p>
<p>STATE:<br />
The internal state of the machine<br />
NN_USOCK_STATE_CONNECTED</p>
<p>ACTION:<br />
A command placing the machine in a new state and possibly raising an event<br />
NN_USOCK_ACTION_CONNECT</p>
<p>EVENT:<br />
Raised when the machine enters a new state<br />
NN_USOCK_EVENT_CONNECTED</p>
<p>The distinction between ACTION and EVENT may or may not be necessary, I don't yet know enough about the internals and you might be just using STATE vs having an EVENT fire and event I believe is your up-stream function call.</p>
<p>I hope this makes sense.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,1803578)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1803578" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1803578)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1803578)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=6978d9d53c53e915c5578aaff5158548&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>mike (guest)</span>, <span class="odate time_1372110831 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">24 Jun 2013 21:53</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-1803729">
                      
		<div class="post" id="post-1803729">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1803729)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1803729">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1372132444 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">25 Jun 2013 03:54</span>
														</div>
			</div>
			<div class="content" id="post-content-1803729">
									

<p>Yes.</p>
<p>The only thing different is that EVENTS have no EVENT prefix. I.e. NN_USOCK_CONNECTED rather than NN_USOCK_EVENT_CONNECTED. The reason is that outgoing events are the only entities visible to the user of the object &#8212; states and actions are private to the state machine. Thus, as the state machine API goes, EVENT prefix would serve no meaningful purpose and just make the identifiers longer.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1803729)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1803729)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1803729" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1803729)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1803729)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1372132444 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">25 Jun 2013 03:54</span>
		</div>
	</div>
 
                
        
            </div>
 
            </div>
 
            </div>
 

	
					
      
    <div class="post-container" id="fpc-1786103">
                      
		<div class="post" id="post-1786103">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1786103)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1786103">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=926ef52b844300c653da8feffc653a9c&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Jiri Sedlacek (guest)</span> <span class="odate time_1369897234 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">30 May 2013 07:00</span>
														</div>
			</div>
			<div class="content" id="post-content-1786103">
									

<p>(This comment talks about callbacks among separate processes)</p>
<p>I can totally see the point of callback hell. Just last week I made an audit of our complete codebase to search for cycles. In my case it was combination of HTTP calls and ZeroMQ REQ/RESP. Found one. It can come back any time. And I still have it easy since I have complete control over the codebase. Imagine you have to prepare for situations where you don't have control over parts of the system. Like I suppose nanomsg doesn't.</p>
<p>Anyway if I had a list of communication protocols (state machines) that is explicit and testable I would feel much better. Especially the internal HTTP calls are dangerous since I don't control the URL. Stable connections from A to B are audit-able. HTTP calls are not.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1786103)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1786103)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1786103" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1786103)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1786103)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=926ef52b844300c653da8feffc653a9c&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Jiri Sedlacek (guest)</span>, <span class="odate time_1369897234 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">30 May 2013 07:00</span>
		</div>
	</div>
 
                
        
                      
    <div class="post-container" id="fpc-1786138">
                      
		<div class="post" id="post-1786138">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1786138)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1786138">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1369902197 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">30 May 2013 08:23</span>
														</div>
			</div>
			<div class="content" id="post-content-1786138">
									

<p>Agreed. State machines would alleviate the problem. However, it's hard to enforce consistent usage of state machines, especially if the development team is large and distributed. There are no widely used software tools to enforce the rules (expect maybe for Erlang) and after all, you just need one person to screw it up.</p>

							</div>

								
							<div class="changes">
					Last edited on <span class="odate time_1369902579 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">30 May 2013 08:29</span>
					by <span class="printuser"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>
					<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.showHistory(event,1786138)"><i class="icon-plus"></i> Show more</a>
				</div>
				<div class="revisions" style="display: none"></div>
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1786138)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1786138)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1786138" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1786138)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1786138)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263514" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1369902197 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">30 May 2013 08:23</span>
		</div>
	</div>
 
                
        
            </div>
 
            </div>
 

	
					
      
    <div class="post-container" id="fpc-1787053">
                      
		<div class="post" id="post-1787053">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1787053)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1787053">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=2463f1bd85aea23703f320e67d33f349&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Marcelo MD (guest)</span> <span class="odate time_1370019302 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">31 May 2013 16:55</span>
														</div>
			</div>
			<div class="content" id="post-content-1787053">
									

<p>So, Martin, can you provide a reference or example of good (and/or bad) state machines implementations?<br />
I thought I knew what I was doing with them. Now I'm not so sure.</p>
<p>I don't really see a problem with state machines per se. Consistent usage of rules and control of source code are problems with software development in general.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1787053)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1787053)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1787053" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1787053)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1787053)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=2463f1bd85aea23703f320e67d33f349&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Marcelo MD (guest)</span>, <span class="odate time_1370019302 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">31 May 2013 16:55</span>
		</div>
	</div>
 
                
        
            </div>
 

	
					
      
    <div class="post-container" id="fpc-1787199">
                      
		<div class="post" id="post-1787199">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1787199)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1787199">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=2ee0b593dd85a099cdf7f288e13f09b3&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>sla (guest)</span> <span class="odate time_1370030504 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">31 May 2013 20:01</span>
														</div>
			</div>
			<div class="content" id="post-content-1787199">
									

<p>Nice one Ambroz, really enjoyed reading your comments!<br />
Callbacks and after effects are common problem and their separation are essential for any reactive system.<br />
And that was one of clearest explanations on LIFO in this case.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1787199)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1787199)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1787199" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1787199)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1787199)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=2ee0b593dd85a099cdf7f288e13f09b3&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>sla (guest)</span>, <span class="odate time_1370030504 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">31 May 2013 20:01</span>
		</div>
	</div>
 
                
        
                      
    <div class="post-container" id="fpc-1787219">
                      
		<div class="post" id="post-1787219">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1787219)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1787219">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span> <span class="odate time_1370032356 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">31 May 2013 20:32</span>
														</div>
			</div>
			<div class="content" id="post-content-1787219">
									

<p>Thanks, sla!</p>
<blockquote>
<p>And that was one of clearest explanations on LIFO in this case.</p>
</blockquote>
<p>Have you seen any other project using a LIFO event queue like that? For all I know, I'm the first one to invent that design pattern ;)</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1787219)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1787219)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1787219" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1787219)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1787219)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=225429bee670de56fadefc4ce4e2dbf5&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Ambroz Bizjak (guest)</span>, <span class="odate time_1370032356 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">31 May 2013 20:32</span>
		</div>
	</div>
 
                
        
            </div>
 
            </div>
 

	
					
      
    <div class="post-container" id="fpc-2299075">
                      
		<div class="post" id="post-2299075">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,2299075)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-2299075">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=071db45a34ac6d62355f3a868593edd4&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Klinkenbecker (guest)</span> <span class="odate time_1432118435 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 May 2015 10:40</span>
														</div>
			</div>
			<div class="content" id="post-content-2299075">
									

<p>Funny how this stuff goes around and around to be reinvented over and over. 20 years ago, I implemented a TCP stack and rapidly came to the conclusion it needed to be an FSM if it was going to be maintainable and extensible.</p>
<p>I was fascinated by the discussion of events verses 'safe' callback handling. The former puts event (handlers) in a (single) queue, the later puts the event handlers in two distinct queues - the LIFO and the stack. They are both fundamentally the same paradigm, they differ only in how the queue(s) is(are) managed.</p>
<p>I would argue that the 'safe' callback method is actually more dangerous for two reasons;<br />
a) because it splits event handlers between the LIFO and the stack &amp;<br />
b) because it depends on a high level of dev discipline to keep track.</p>
<p>b) violates a fundamental rule that, despite all best intentions everyone is fallible.</p>
<p>I have not reviewed code, but you will find that the 'cleaner' (i.e. cleanly abstracted) your event paradigm, the easier it will be for devs to use the pattern and thus, they will be less likely to spend energy implementing something else. 'Clean' abstraction means easy setup, simple APIs, transparent architecture, event queue management (typically at least 3 levels) and queue visibility (debugging and system handling).</p>
<p>I have since taken the (event) paradigm to the ultimate conclusion of eliminating the need for threads (RTOS) altogether in many systems.</p>
<p>fwiw&#8230;</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,2299075)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,2299075)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-2299075" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,2299075)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,2299075)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=071db45a34ac6d62355f3a868593edd4&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Klinkenbecker (guest)</span>, <span class="odate time_1432118435 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 May 2015 10:40</span>
		</div>
	</div>
 
                
                	


        
                      
    <div class="post-container" id="fpc-2299081">
                      
		<div class="post" id="post-2299081">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,2299081)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-2299081">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=ccbe7da9a44a8737ca2eda4462c42fe1&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Martin Sustrik (guest)</span> <span class="odate time_1432119125 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 May 2015 10:52</span>
														</div>
			</div>
			<div class="content" id="post-content-2299081">
									

<p>+1 for not using threads at all.</p>
<p>I wonder how the stuff even got so widespread in the first place. We had a perfectly viable model (processes&amp;pipes) even before threads so there was no obvious reason&#8230; except maybe, when you are coding a boring crud application, using threads generates a lot of fun. Not even speaking of job security :)</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,2299081)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,2299081)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-2299081" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,2299081)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,2299081)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=ccbe7da9a44a8737ca2eda4462c42fe1&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Martin Sustrik (guest)</span>, <span class="odate time_1432119125 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 May 2015 10:52</span>
		</div>
	</div>
 
                
        
            </div>
 
            </div>
 


<div class="pager"><span class="pager-no">page 1 of 2</span><span class="current">1</span><span class="target"><a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadPostsModule.listeners.updateList(2)">2</a></span><span class="target"><a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadPostsModule.listeners.updateList(2)">next &raquo;</a></span></div>
</div>

        <a href="javascript:;" id="new-post-button" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.newPost(event,null)"
      style="display:  none ; margin-bottom:1em"
    >Add a New Comment</a>


    <div id="new-post-form-container">
        <div id="new-post-preview-div" style="display: none">
            <h1>Post preview:</h1>
            <div class="post-container"></div>
            <div></div>
            <a href="javascript:;" onclick="WIKIDOT.modules.ForumNewPostFormModule.listeners.closePreview(event)" class="btn btn-danger">Close preview</a>
        </div>

        <div id="new-post-div" class="well">
            <form id="new-post-form" onkeypress="return OZONE.utils.disableEnterKey(event)">
                <input type="hidden" name="threadId" value="656490"/>
                <input type="hidden" name="parentId" value=""/>
                                    <table class="guest-commenting">
                        <tr>
                            <td><input class="text form-control" name="guestName" type="text" maxlength="30" value="" title="Name"/></td>
                            <td>or <a href="#action:login">Sign in as Wikidot user</a></td>
                        </tr>
                        <tr>
                            <td><input class="text form-control" name="guestEmail" type="text" maxlength="50" value="" title="E-mail address"/></td>
                            <td>(will not be published)</td>
                        </tr>
                    </table>
                                <div><textarea id="np-text" name="source" rows="10" cols="50" class="form-control"></textarea></div>
                <div class="change-textarea-size">
                    <a href="javascript:;" onclick="WIKIDOT.utils.changeTextareaRowNo('np-text',-5)">-</a>
                    <a href="javascript:;" onclick="WIKIDOT.utils.changeTextareaRowNo('np-text',5)">+</a>
                </div>
                <div class="edit-help-34">
                    Help: <a href="http://www.wikidot.com/doc:quick-reference" target="_blank">wiki text quick reference</a>                </div>
                                
                <div id="edit-post-captcha"></div>
                
                <div class="buttons alignleft">
                    <input class="btn btn-danger btn-small btn-sm" type="button" value="Cancel" id="np-cancel" onclick="WIKIDOT.modules.ForumNewPostFormModule.listeners.cancel(event)"/>
                    <input class="btn btn-default btn-small btn-sm" type="button" value="Preview" id="np-preview" onclick="WIKIDOT.modules.ForumNewPostFormModule.listeners.preview(event)"/>
                    <input class="btn btn-primary btn-small btn-sm" type="button" value="Post it" id="np-post" onclick="WIKIDOT.modules.ForumNewPostFormModule.listeners.save(event)"/>
                </div>
                    
            </form>
        </div>	

    </div> 
            <script type="text/javascript">
            
            $j(function() {
                WIKIDOT.Editor.init("np-text", "np-editor-panel");
            });
            
        </script>
    
 

<div style="display:none" id="post-options-template">
	<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.showPermalink(event,'%POST_ID%')" class="btn btn-default btn-small btn-sm">Permanent Link</a>
			<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.editPost(event,'%POST_ID%')" class="btn btn-default btn-small btn-sm">Edit</a>
			<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.deletePost(event,'%POST_ID%')" class="btn btn-danger btn-small btn-sm">Delete</a>
</div>
	
			</div>
	
	
	
</div></div>

                    </div>

                    


                    



                    

                    <div id="page-info-break"></div>
                    
                        <div id="page-options-container">
                            
                        </div>
                    
                    <div id="action-area" style="display: none;"></div>
                </div>
            </div>
            
            
            
            <div id="footer" style="display: block; visibility: visible;">
                <div class="options" style="display: block; visibility: visible;">
    <a href="http://www.wikidot.com/doc" id="wikidot-help-button">Help</a>
    &nbsp;|
    <a href="http://www.wikidot.com/legal:terms-of-service" id="wikidot-tos-button">Terms of Service</a>
    &nbsp;|
    <a href="http://www.wikidot.com/legal:privacy-policy" id="wikidot-privacy-button">Privacy</a>
    &nbsp;|
    <a href="javascript:;" id="bug-report-button" onclick="WIKIDOT.page.listeners.pageBugReport(event)">Report a bug</a>
    &nbsp;|
    <a href="javascript:;" id="abuse-report-button" onclick="WIKIDOT.page.listeners.flagPageObjectionable(event)">Flag as objectionable</a>
</div>
Powered by <a href="http://www.wikidot.com">Wikidot.com</a> 
            </div>
            
                <div id="license-area" class="license-area">
                    Unless otherwise stated, the content of this page is licensed under <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 License</a>
                </div>
            
            
            



            <div id="extrac-div-1"><span></span></div><div id="extrac-div-2"><span></span></div><div id="extrac-div-3"><span></span></div>
            
            
            
            
                
            
        </div>
        
    </div>
<!-- These extra divs/spans may be used as catch-alls to add extra imagery. -->
<div id="extra-div-1"><span></span></div><div id="extra-div-2"><span></span></div><div id="extra-div-3"><span></span></div>
<div id="extra-div-4"><span></span></div><div id="extra-div-5"><span></span></div><div id="extra-div-6"><span></span></div>
</div>




</div>
<div id="dummy-ondomready-block" style="display: none;" ></div>
    <!-- Google Analytics load -->
    <script type="text/javascript">
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

    <!-- Quantcast -->
    <script type="text/javascript">
    _qoptions={
        qacct:"p-edL3gsnUjJzw-"
    };
    (function() {
        var qc = document.createElement('script'); qc.type = 'text/javascript'; qc.async = true;
        qc.src = ('https:' == document.location.protocol ? 'https://secure' : 'http://edge') + '.quantserve.com/quant.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(qc, s);
    })();
    </script>
    <noscript>
        <img src="http://pixel.quantserve.com/pixel/p-edL3gsnUjJzw-.gif" style="display: none;" border="0" height="1" width="1" alt="Quantcast"/>
    </noscript>




<div id="page-options-bottom-tips" style="display: none;">
    <div id="edit-button-hovertip">
        Click here to edit contents of this page.    </div>
</div>
<div id="page-options-bottom-2-tips"  style="display: none;">
    <div id="edit-sections-button-hovertip">
        Click here to toggle editing of individual sections of the page (if possible).         Watch headings for an &quot;edit&quot; link when available.    </div>
    <div id="edit-append-button-hovertip">
        Append content without editing the whole page source.    </div>
    <div id="history-button-hovertip">
        Check out how this page has evolved in the past.    </div>
    <div id="discuss-button-hovertip">
        If you want to discuss contents of this page - this is the easiest way to do it.    </div>
    <div id="files-button-hovertip">
        View and manage file attachments for this page.    </div>
    <div id="site-tools-button-hovertip">
        A few useful tools to manage this Site.    </div>
    <div id="backlinks-button-hovertip">
        See pages that link to and include this page.    </div>
    <div id="rename-move-button-hovertip">
        Change the name (also URL address, possibly the category) of the page.    </div>
    <div id="view-source-button-hovertip">
        View wiki source for this page without editing.    </div>
    <div id="parent-page-button-hovertip">  
        View/set parent page (used for creating breadcrumbs and structured layout).    </div>
            <div id="abuse-report-button-hovertip">
            Notify administrators if there is objectionable content in this page.        </div>
        <div id="bug-report-button-hovertip">
            Something does not work as expected? Find out what you can do.        </div>
        <div id="wikidot-help-button-hovertip">
            General Wikidot.com documentation and help section.        </div>
        <div id="wikidot-tos-button-hovertip">
            Wikidot.com Terms of Service - what you can, what you should not etc.        </div>
        <div id="wikidot-privacy-button-hovertip">
            Wikidot.com Privacy Policy.          
        </div>
    </div>
</body>
</html>