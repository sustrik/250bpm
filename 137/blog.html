<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
    <title>Update on Structured Concurrency - 250bpm</title>
    
    	<script type="text/javascript" src="http://www.wikidot.com/default__flow/login__CustomDomainScript?site_id=148706"></script>

    
    <script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--javascript/init.combined.js"></script>
    <script  type="text/javascript">
        var URL_HOST = 'www.wikidot.com';
        var URL_DOMAIN = 'wikidot.com';
        var USE_SSL =  true ;
        var URL_STATIC = 'http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9';
        // global request information
        
        var WIKIREQUEST = {};
        WIKIREQUEST.info = {};
        
        WIKIREQUEST.info.domain = "250bpm.com";
        WIKIREQUEST.info.siteId = 148706;
        WIKIREQUEST.info.siteUnixName = "250bpm";
        WIKIREQUEST.info.categoryId = 2550760;
        WIKIREQUEST.info.themeId = 18520;
        WIKIREQUEST.info.requestPageName = "blog:137";
        OZONE.request.timestamp = 1594263594;
        OZONE.request.date = new Date();
        WIKIREQUEST.info.lang = 'en';
                WIKIREQUEST.info.pageUnixName = "blog:137";
        WIKIREQUEST.info.pageId = 180002494;
                        WIKIREQUEST.info.lang = "en";
        OZONE.lang = "en";
        var isUAMobile = !!/Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    </script>
    
    


    
        <script  type="text/javascript">
    
        require.config({
            baseUrl: URL_STATIC + '/common--javascript',
            paths: {
                'jquery.ui': 'jquery-ui.min',
                'jquery.form': 'jquery.form'
            }
        });
    
    </script>
    
    <meta http-equiv="content-type" content="text/html;charset=UTF-8"/>
            
    
    
    
    
    <meta http-equiv="content-language" content="en"/>
    <script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--javascript/WIKIDOT.combined.js"></script>
        
    
    <style type="text/css" id="internal-style">
        
        /* modules */
        
                
        /* theme */
                    @import url(http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--theme/base/css/style.css);
                    @import url(http://250bpm.wdfiles.com/local--theme/250bpm/style.css);
            </style>
    
        
        
        
    <link rel="shortcut icon" href="/local--favicon/favicon.gif"/>
    <link rel="icon" type="image/gif" href="/local--favicon/favicon.gif"/>
    
            <link rel="apple-touch-icon" href="/common--images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="/common--images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="/common--images/apple-touch-icon-114x114.png" />
        
        
            <link rel="alternate" type="application/wiki" title="Edit this page" href="javascript:WIKIDOT.page.listeners.editClick()"/>
    
        <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-18234656-1']);
        _gaq.push(['_setDomainName', 'none']);
        _gaq.push(['_setAllowLinker', true]);
        _gaq.push(['_trackPageview']);

        _gaq.push(['old._setAccount', 'UA-68540-5']);
        _gaq.push(['old._setDomainName', 'none']);
        _gaq.push(['old._setAllowLinker', true]);
        _gaq.push(['old._trackPageview']);

                _gaq.push(['userTracker._setAccount', 'UA-3207370-9']);
        _gaq.push(['userTracker._trackPageview']);
            </script>
    
    <script type="text/javascript">
        window.google_analytics_uacct = 'UA-18234656-1';
        window.google_analytics_domain_name = 'none';
    </script>
    
        <link rel="manifest" href="/onesignal/manifest.json" />
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" acync=""></script>
    <script>
        var OneSignal = window.OneSignal || [];
        OneSignal.push(function() {
          OneSignal.init({
            appId: null,
          });
        });
    </script>
        
<link rel="alternate" type="application/rss+xml" title="Comments for the page &quot;Update on Structured Concurrency&quot;" href="/feed/page/comments-180002494.xml"/><script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--modules/js/forum/ForumCommentsModule.js"></script>
<script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--modules/js/forum/ForumViewThreadModule.js"></script>
<script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--modules/js/forum/ForumViewThreadPostsModule.js"></script>
<script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--modules/js/forum/sub/ForumNewPostFormModule.js"></script>
</head>
<body id="html-body">
<div id="skrollr-body">
<a name="page-top"></a>





<div id="container-wrap-wrap">
    <div id="container-wrap">
        <div id="container">
            <div id="header">
              <h1><a href="/"><span>250bpm</span></a></h1>
                
                
                <!-- google_ad_section_start(weight=ignore) -->
                
                <div id="search-top-box" class="form-search">
    <form id="search-top-box-form" action="dummy" class="input-append">
        <input id="search-top-box-input" class="text empty search-query" type="text" size="15" name="query" value="Search this site" onfocus="if(YAHOO.util.Dom.hasClass(this, 'empty')){YAHOO.util.Dom.removeClass(this,'empty'); this.value='';}"/><input class="button btn" type="submit" name="search" value="Search"/>
    </form>
</div>
                
                
                    <div id="top-bar">
                        

<ul>
<li><a href="/">Home</a></li>
<li><a href="https://github.com/sustrik/cartesian">Cartesian</a></li>
<li><a href="http://libdill.org">Libdill</a></li>
<li><a href="http://nanomsg.org">Nanomsg</a></li>
<li><a href="https://github.com/sustrik/tiles">Tiles</a></li>
<li><a href="http://zero.mq">ZeroMQ</a></li>
<li><a href="/contact">Contact</a></li>
</ul>

                    </div>
                
                <div id="login-status"><a href="javascript:;" onclick="WIKIDOT.page.listeners.createAccount(event)" class="login-status-create-account btn">Create account</a> <span>or</span> <a href="javascript:;" onclick="WIKIDOT.page.listeners.loginClick(event)" class="login-status-sign-in btn btn-primary">Sign in</a> </div>
                <div id="header-extra-div-1"><span></span></div><div id="header-extra-div-2"><span></span></div><div id="header-extra-div-3"><span></span></div>
            </div>
            
            <div id="content-wrap">
                
                    <div id="side-bar">
                        


                        


                        


                    </div>
                
                
                <!-- google_ad_section_end -->
                
                <div id="main-content">
                    <div id="action-area-top"></div>
                    
                    
                        <div id="page-title">
                            Update on Structured Concurrency
                        </div>
                    

                    

                    



                    <div id="page-content">
                        

<div style="width:50em">
<p>Since I've written the article on <a href="http://250bpm.com/blog:71">structured concurrency</a> and implemented <a href="http://libdill.org/">libdill</a> the progress went on.</p>
<p>Most importantly, Nathaniel J. Smith has published his &quot;<a href="https://vorpus.org/blog/notes-on-structured-concurrency-or-go-statement-considered-harmful/">Notes on structured concurrency, or: Go statement considered harmful</a>&quot; article. (If you prefer to watch a video, go <a href="https://www.youtube.com/watch?v=oLkfnc_UMcE">here</a>.) It's better, more detailed and more eloquent than anything I have ever written on the topic. If you want to read one thing about structured concurrency go read Nathaniel's article.</p>
<p>After C-based libdill we've also got <a href="http://zewo.github.io/Venice/">Venice</a> which brought structured concurrency to Swift and <a href="https://trio.readthedocs.io/en/latest/">Trio</a> which brought it to Python.</p>
<p>Then, few weeks ago, a new version of Kotlin's coroutine library was released that supports structured concurrency. Here's the accompanying <a href="https://medium.com/@elizarov/structured-concurrency-722d765aa952">blog post</a> by Roman Elizarov.</p>
<p>&quot;<a href="https://medium.com/@belm0/concurrency-made-easy-d3fdb0382c58">Concurrency made easy: coming soon to a programming language near you</a>&quot; recently published by John Belmonte takes another thoughtful shot at explaining the paradigm. It also summarizes the state of its adoption.</p>
<p>Finally, I would like to point out Aleksey Kladov's blog post &quot;<a href="https://matklad.github.io/2018/06/18/exceptions-in-structured-concurrency.html">Exceptions vs Structured Concurrency</a>&quot; which goes beyond simple &quot;let's tie thread lifetimes to lexical scopes!&quot; agenda and discusses some hard questions of the actual semantics implied by structured concurrency paradigm. He does so in the context of Rust's <a href="https://github.com/crossbeam-rs/crossbeam">crossbeam</a> library. We need more stuff like this.</p>
<p>All of that is great work and I hope we'll see more of it in the future!</p>
<p>For now, let me make few comments about stuff that may not be new, but which is sort of advanced and haven't been covered well enough yet.</p>
<h3 id="toc0"><span>Thread bundles: It's not just syntactic sugar</span></h3>
<p>Libdill, Trio and Kotlin all introduce a concept of thread bundles. In libdill it's called &quot;bundle&quot;, in Trio it's &quot;nursery&quot;, in Kotlin it's &quot;scope&quot; (it would be nice to have some unified terminology here). At first sight it looks just like syntactic sugar that allows you to cancel all the threads within the bundle in one go.</p>
<p>However, it's more than that. It allows you to cancel a bunch of threads in <strong>parallel</strong>.</p>
<p>To understand why it matters, consider a network server with 1000 open connections. Each connection is handled by its dedicated thread. Also, let's assume we want to give each connection one second to do clean shutdown, to perform termination handshake with the peer etc.</p>
<p>If we canceled the connections in a simple for loop, the shutdown of the server would take, in the worst case, 1000 seconds, i.e. more than 16 minutes. In fact, if you are facing a DoS attack that opens connections and then leaves them hanging, it would take exactly 16 minutes 40 seconds. If, on the other hand, there was a construct to cancel the connections in parallel, the server would shut down in just one second. That's a difference that would make ops people cry.</p>
<h3 id="toc1"><span>Ordered cancellation</span></h3>
<p>There's a temptation to equate thread bundles with scopes: All the threads launched within the scope would be canceled in parallel when the scope is exited.</p>
<p>There's a problem with that. Imagine that, within the scope, we create a logging thread first, then wait for incoming connections and launch one thread per connection. Given that all the threads were launched within the same scope, they will be canceled in parallel. It may happen that the logging thread would exit first. In that case all the logs produced by the connections while they are shutting down would be lost.</p>
<p>What we really want is shutting down the connections first, then shutting down the logging thread.</p>
<p>You can do that by nesting the scopes like this:</p>
<div class="code">
<pre>
<code>async with trio.open_nursery() as n1:
    n1.start_soon(logger)
    async with trio.open_nursery() as n2:
        while True:
            ...
            n2.start(connection)</code>
</pre></div>
<p>Doable, but consider that instead of two threads you had five threads. And you wanted to cancel them in a particular order. The five nested blocks would look somewhat ugly.</p>
<p>One way to deal with that would be to adopt semantics a bit like that of C++ destructors: The destructors are called in the reverse order of how the constructors were called.</p>
<div class="code">
<pre>
<code>{
    nursery n1;
    n1.start_soon(logger);
    nursery n2;
    while(1) {
        ...
        n2.start_soon(connection);
    }
} // n2 is shut down here (all connections in parallel), when done, n1 is canceled</code>
</pre></div>
<p>We should also think about whether it would be worth it &#8212; at least in statically typed languages &#8212; to impose a discipline on the programmer and allow them to run only one type of thread within one bundle/nursery. It would mean that different types of threads could not be shut down in parallel. But that's probably what we want anyway. (Counterexamples are welcome!)</p>
<div class="code">
<pre>
<code>{
    nursery&lt;logger&gt; n1;
    n1.start_soon();
    nursery&lt;connection&gt; n2;
    while(1) {
        ...
        n2.start_soon();
    }
}</code>
</pre></div>
<h3 id="toc2"><span>Deadlines, cancellations, grace periods</span></h3>
<p>Imagine, again, the case of a network server. We may want to limit the lifetime of each connection to one hour. If it's lasts longer than that it either means that we've lost connectivity or that the peer is trying to perform a DoS attack. So let's just shut it down.</p>
<p>So far so good.</p>
<p>However, imagine we want to shut down the server. Canceling everything immediately would be easy. Just exit the main scope.</p>
<p>But we still want to give connections a one minute grace period to shut down cleanly. What we can do, in the main thread, is to sleep for one minute, then exit. But it feels ugly. Why wait for one minute even if all the connections terminated within few seconds?</p>
<p>We have a conflict of deadlines here. The connection threads are supposed to deadline in both one hour and one minute. How are we supposed to deal with that in a clean way?</p>
<p>Libdill provides bundle_wait() function which has a deadline parameter. It waits for all the threads in the bundle (nursery) to finish. When they do, it exits. If the deadline expires and some threads are still running it cancels them and exits.</p>
<p>This approach works for C where cancellation has to be done by hand anyway, but it's kind of clumsy in more sophisticated languages where it is supposed to happen automatically.</p>
<p>To be frank, I am not sure whether this scenario can be implemented in Trio. <a href="https://trio.readthedocs.io/en/latest/reference-core.html?highlight=timeout#cancellation-semantics">This section</a> of the docs discusses the cancellation semantics but I don't see any obvious match there. (Correct me if I'm wrong!) I am not sure about Kotlin's implementation either.</p>
<h3 id="toc3"><span>Multi-core support</span></h3>
<p>Finally, it should be said that all the implementations that I am aware of use coroutines and ignore OS threads. What that means is they can't use structured concurrency on more than one CPU core. At the same time there seems to be no inherent reason why OS threads or processes couldn't be made part of the structured concurrency world.</p>
<p>There may be technical reasons though.</p>
<p>I once implemented launching of OS process that was semantically equivalent to launching a coroutine in libdill, with cancellation and everything. You just had to use go_process() instead of go(). Surprisingly, it worked.</p>
<p>But then I deleted it. And I haven't even tried with OS threads.</p>
<p>The reason was that implementation of threads in the C standard library (pthreads) is complex and fragile. It contains a lot of corner cases and poorly specified behavior. Once signals are added to the mix all bets are off. Even if you make it work on one operating system, there's no guarantee that you won't experience weird behavior on a different operating system.</p>
<p>And I really don't want to deal with that complexity. Libdill is a hobby project and I have only limited time to spend on it.</p>
<p>But, eventually, if structured concurrency is to take off, it will have to deal with OS threads and processes. It would need people with enough free time and enthusiasm to deal with the complexity and maybe also some political will to change standard libraries in such a way that they play well with structured concurrency.</p>
<p><strong>October 19th, 2018</strong></p>
<div class="comments-box">
		
	<div class="options" id="comments-options-hidden" style="display: none">
		<a href="javascript:;" onclick="WIKIDOT.modules.ForumCommentsModule.listeners.showComments(event)">Show Comments</a> 
	</div>
		
	<div id="thread-container" class="thread-container" style="margin-top: 1em">
					


<script type="text/javascript">
	WIKIDOT.forumThreadId = 8117771;
</script>


	<div class="options" id="comments-options-shown">
		<a href="javascript:;" onclick="WIKIDOT.modules.ForumCommentsModule.listeners.hideComments(event)" class="btn btn-default btn-small btn-sm">Hide All Comments</a> 
		<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.unfoldAll(event)" class="btn btn-default btn-small btn-sm">Unfold All</a> 
		<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.foldAll(event)" class="btn btn-default btn-small btn-sm">Fold All</a>
	</div>

<div id="thread-container-posts" style="display: none">
    



	
					
      
    <div class="post-container" id="fpc-4029508">
                      
		<div class="post" id="post-4029508">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4029508)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4029508">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=97c543aca1ac7bbcfb5279d0300c8330&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Nathaniel J. Smith (guest)</span> <span class="odate time_1539998739 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Oct 2018 01:25</span>
														</div>
			</div>
			<div class="content" id="post-content-4029508">
									

<p>Regarding grace periods: yeah, this is something we're still trying to figure out how to handle nicely in Trio. (<a href="https://github.com/python-trio/trio/issues/147">Discussion thread</a>.)</p>
<p>Your challenge with combining the one hour deadline and the one minute deadline is actually easy in Trio: cancel scopes can be nested, and you can change cancel scope deadlines on the fly. So each connection handler will have its own cancel scope with a one hour timeout, and for the grace period, you wrap your whole program in a cancel scope, and when you want to shut down, set that shared scope's deadline to 1 minute. Trio will take care of composing those deadlines together.</p>
<p>But in real life, that's not enough, because during the grace period you usually want to expedite things, e.g. by letting in-progress requests finish, but not accepting any new incoming requests. So you need some way to communicate to everyone to stop accepting new requests, including to tasks that are e.g. blocked in accept().</p>
<p>Our tentative idea is to add a &quot;soft cancelled&quot; state to our cancel scopes. Currently, when a cancel scope enters the cancelled state, that's delivered to any blocking operations by default, but they can explicitly opt-out (using &quot;shielding&quot;). A soft cancel state would *not* be delivered by default, except for operations that explicitly opt-in. So then for a conventional graceful shutdown you'd do a soft cancel + set a hard deadline, and make sure that accept loops and similar all opt-in to soft cancellation.</p>
<p>Regarding multi-core support: Yeah, there's definitely no reason why you couldn't combine structured concurrency with a multi-core scheduler. The one big problem is that you really want solid cancellation support. (Of course you want this anyway, but if you're trying to be structured then you're sort of forced to deal with it.) And on popular OSes the standard blocking APIs have terrible support for cancellation. So, even if you're using a multi-core scheduler, you can't use traditional blocking libraries; you still have to build a whole new set of I/O primitives with cancellation support, and then rewrite all your libraries to use them. This is a lot easier to justify if you're writing an async library, since for unrelated reasons, async libraries *also* need to build a new set of I/O primitives and rewrite everything to use them, so you can sneak the cancellation support in at the same time.</p>
<p>I don't think there's any way to retrofit cancellation support into classic blocking APIs, and even if you could you wouldn't want to – you can't expect existing libraries to handle it correctly. OTOH there's no reason you couldn't implement a new set of APIs that act like the classic blocking synchronous ones, but that support cancellation. (I <a href="https://vorpus.org/blog/timeouts-and-cancellation-for-humans/#synchronous-single-threaded-python">discuss this a little</a> in <a href="https://vorpus.org/blog/timeouts-and-cancellation-for-humans/">my cancellation post</a>.)</p>
<p>Golang even demonstrates that it's possible to provide a conventional blocking synchronous I/O API where all the blocking operations are integrated with a user-space scheduler, using existing OS APIs under the hood. But unfortunately, they didn't bake in cancellation when they were doing that. It's too bad – a real missed opportunity :-(.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,4029508)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,4029508)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4029508" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4029508)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4029508)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=97c543aca1ac7bbcfb5279d0300c8330&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Nathaniel J. Smith (guest)</span>, <span class="odate time_1539998739 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Oct 2018 01:25</span>
		</div>
	</div>
 
                
                	


        
                      
    <div class="post-container" id="fpc-4029868">
                      
		<div class="post" id="post-4029868">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4029868)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4029868">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1540016788 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Oct 2018 06:26</span>
														</div>
			</div>
			<div class="content" id="post-content-4029868">
									

<blockquote>
<p>Our tentative idea is to add a &quot;soft cancelled&quot; state to our cancel scopes. Currently, when a cancel scope enters the cancelled state, that's delivered to any blocking operations by default, but they can explicitly opt-out (using &quot;shielding&quot;). A soft cancel state would *not* be delivered by default, except for operations that explicitly opt-in. So then for a conventional graceful shutdown you'd do a soft cancel + set a hard deadline, and make sure that accept loops and similar all opt-in to soft cancellation.</p>
</blockquote>
<p>Isn't that just ordered cancellation (see above) in disguise? If you had one nursery with the thread that accepts connections and another nursery with connections themselves, then you can cancel the former first, the latter second.</p>
<blockquote>
<p>And on popular OSes the standard blocking APIs have terrible support for cancellation.</p>
</blockquote>
<p>In theory, the support is there. You can use pthread_kill() to send signal to a thread and if the thread is stuck inside a blocking function, the function should return with EINTR error. Except that I have no confidence in this working properly. But, on the other hand, if standard lib folks actually tried to make it work, then I can see a way forward. (Btw, you can do the same with processes, just use kill() instead of pthread_kill()).</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,4029868)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,4029868)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4029868" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4029868)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4029868)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1540016788 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Oct 2018 06:26</span>
		</div>
	</div>
 
                
        
                      
    <div class="post-container" id="fpc-4029925">
                      
		<div class="post" id="post-4029925">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4029925)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4029925">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=a73ad583d743a0d6e67e1f599de18bd3&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Matthias Urlichs (guest)</span> <span class="odate time_1540020511 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Oct 2018 07:28</span>
														</div>
			</div>
			<div class="content" id="post-content-4029925">
									

<p>It's not just ordered cancellation. Consider a HTML1.1 connection. You want to teach it to throw away incomplete requests but to return in-progress responses. So your HTML 1.1 handler would enable soft-cancel while reading from the socket, disable them while generating and sending the reply, repeat.</p>
<p>Granted that in this case you could simply call shutdown(RDR) on the socket, but that won't work on HTML2.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,4029925)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4029925" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4029925)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4029925)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=a73ad583d743a0d6e67e1f599de18bd3&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Matthias Urlichs (guest)</span>, <span class="odate time_1540020511 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Oct 2018 07:28</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-4029945">
                      
		<div class="post" id="post-4029945">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4029945)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4029945">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1540021519 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Oct 2018 07:45</span>
														</div>
			</div>
			<div class="content" id="post-content-4029945">
									

<p>Why would you want to do that? Say you are shutting down a HTTP server. You give it 1 second grace period. Does it make any difference whether, within that interval, it just processes fully received requests or whether it finishes reading half-read requests and processes them? It's still 1 second. Who cares?</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,4029945)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4029945" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4029945)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4029945)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1540021519 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Oct 2018 07:45</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-4030998">
                      
		<div class="post" id="post-4030998">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4030998)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4030998">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=97c543aca1ac7bbcfb5279d0300c8330&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Nathaniel J. Smith (guest)</span> <span class="odate time_1540066560 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Oct 2018 20:16</span>
														</div>
			</div>
			<div class="content" id="post-content-4030998">
									

<p>Think about a client attempting to perform a non-idempotent HTTP request. From the client's perspective, there are three possible outcomes: clean success, clean failure, or an ambiguous state where it doesn't know whether it failed or not. Clean failure is fine – you just retry. But if you're in the ambiguous state, you're screwed, because you don't know whether you can safely retry or not.</p>
<p>The point of stopping accepting incoming requests is to minimize the number of requests that end up in the ambiguous third state, and convert them into clean failures instead. In fact, if you know that all requests finish in less than N seconds, and you set an N second timeout, then that gives you a guarantee that *no* requests will end up in the ambiguous state unless there's some other independent failure (network partition, power loss, etc.). If you keep accepting new requests during the grace period, then there's no guarantee at all.</p>
<p>It's also nice operationally because it lets you safely use a large grace period – like a minute or whatever – just in case there's some really long-running request, while knowing that in 99% of cases it will terminate in a second or two. If you keep accepting new requests during the grace period, then a busy server will always use the whole grace period, and &quot;graceful&quot; shutdown becomes essentially equivalent to a hard shutdown.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,4030998)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4030998" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4030998)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4030998)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=97c543aca1ac7bbcfb5279d0300c8330&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Nathaniel J. Smith (guest)</span>, <span class="odate time_1540066560 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Oct 2018 20:16</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-4031528">
                      
		<div class="post" id="post-4031528">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4031528)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4031528">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1540102268 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Oct 2018 06:11</span>
														</div>
			</div>
			<div class="content" id="post-content-4031528">
									

<p>I get that, but how is that not achieved by my proposal above: &quot;If you had one nursery with the thread that accepts connections and another nursery with connections themselves, then you can cancel the former first, the latter second.&quot; ?</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,4031528)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4031528" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4031528)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4031528)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1540102268 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Oct 2018 06:11</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-4031601">
                      
		<div class="post" id="post-4031601">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4031601)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4031601">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=97c543aca1ac7bbcfb5279d0300c8330&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Nathaniel J. Smith (guest)</span> <span class="odate time_1540106700 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Oct 2018 07:25</span>
														</div>
			</div>
			<div class="content" id="post-content-4031601">
									

<p>Hmm, I had a longer reply but it seems to have been eaten somewhere.</p>
<p>If you've already started reading a request, then sure, it makes sense to go ahead and finish reading it. But with HTTP/1.1 keepalive and HTTP/2, it's very common to have a connection that's sitting idle waiting for the next request to arrive. You need to inform your connection handler tasks about the graceful shutdown, so that they go ahead and close these connections instead of continuing to wait.</p>
<p>This is all totally doable with Trio currently. Our helper functions for servers even <a href="https://trio.readthedocs.io/en/latest/reference-io.html#trio.serve_tcp">take a handler_nursery argument</a> exactly because we want to make it possible to split up the accepter tasks from the connection handler tasks so they can be cancelled separately. But plumbing everything together requires some complex global coordination, so maybe it would be better to provide some first-class mechanism for doing that instead of expecting every user to wire everything together themselves. Not sure. This is why I use words like &quot;tentative idea&quot; here :-).</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,4031601)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4031601" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4031601)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4031601)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=97c543aca1ac7bbcfb5279d0300c8330&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Nathaniel J. Smith (guest)</span>, <span class="odate time_1540106700 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Oct 2018 07:25</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-4031636">
                      
		<div class="post" id="post-4031636">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4031636)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4031636">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=97c543aca1ac7bbcfb5279d0300c8330&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Nathaniel J. Smith (guest)</span> <span class="odate time_1540109280 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Oct 2018 08:08</span>
														</div>
			</div>
			<div class="content" id="post-content-4031636">
									

<blockquote>
<p>In theory, the support is there. You can use pthread_kill() to send signal to a thread and if the thread is stuck inside a blocking function, the function should return with EINTR error. Except that I have no confidence in this working properly. But, on the other hand, if standard lib folks actually tried to make it work, then I can see a way forward. (Btw, you can do the same with processes, just use kill() instead of pthread_kill()).</p>
</blockquote>
<p>It's&#8230;&#8230;. more complicated than that :-). Not all popular OSes have pthread_kill (in particular, Windows has no equivalent to EINTR). On the ones that do, it works as documented AFAICT, but does that help? You can use pthread_kill to obliterate a thread (by defining a signal handler that calls pthread_exit), but you never ever want to do that, because it becomes impossible to maintain any kind of program invariants. (E.g., what if the obliterated thread was in the middle of updating some data structure, or holding a lock?) And if you try to define some more sensible cancellation semantics – like POSIX actually did, with pthread_cancel – and then implement those using pthread_kill, then <a href="http://ewontfix.com/2/">you get nasty race conditions</a>. And then even if you fix *those*, you still have the problem that you still have to rewrite all your libraries to handle cleanup after cancellation correctly, and if you're going to do that then it's just as easy to switch them to use the newer OS APIs that have more sensible support for cancellation.</p>
<p>pthread_kill is potentially useful to construct a non-blocking read/write primitive on Unix OSes for cases where you can't put the fd into non-blocking mode (in particular stdin/stdout/stderr, <a href="https://github.com/python-trio/trio/issues/174#issuecomment-314939704">details</a>). But even then you have to claim the use of a signal, which is problematic for a library that might want to coexist with arbitrary other libraries in the same process, since signals are a process-global resource.</p>
<p>pthread_kill is super powerful but it's incredibly difficult to find a case where it's actually useful.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,4031636)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,4031636)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4031636" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4031636)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4031636)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=97c543aca1ac7bbcfb5279d0300c8330&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Nathaniel J. Smith (guest)</span>, <span class="odate time_1540109280 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Oct 2018 08:08</span>
		</div>
	</div>
 
                
        
            </div>
 
            </div>
 
                      
    <div class="post-container" id="fpc-4030677">
                      
		<div class="post" id="post-4030677">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4030677)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4030677">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/roman-elizarov" onclick="WIKIDOT.page.listeners.userInfo(4763582); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=4763582&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="Roman  Elizarov" style="background-image:url(http://www.wikidot.com/userkarma.php?u=4763582)"/></a><a href="http://www.wikidot.com/user:info/roman-elizarov" onclick="WIKIDOT.page.listeners.userInfo(4763582); return false;" >Roman  Elizarov</a></span> <span class="odate time_1540048315 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Oct 2018 15:11</span>
														</div>
			</div>
			<div class="content" id="post-content-4030677">
									

<p>Kotlin coroutines have multi-core support. It is obviously complex under the hood (just like the OS kernels, as you correctly note), but the users are not exposed to that complexity. It all just works for them.</p>
<p>Cancellation is definitely easier for coroutines than for threads, since it is fully cooperative. It only works with async APIs, of course, so we are gradually expanding the set of non-blocking APIs available to the users by providing them with the corresponding non-blocking libraries.</p>
<p>When coroutine is cancelled in Kotlin it immediately and synchronously notifies all its children about cancellation, and then waits for all of them to complete, which is a good default when you what to terminate something as quickly as possible.</p>
<p>To perform a graceful shutdown we use the following pattern. Let us take a web server, for example. We keep its acceptor coroutine in a separate scope from all the connection coroutines. To shut it down gracefully we cancel its acceptor coroutine in a normal (non-graceful) way and then wait for the scope with connections to for a given time, giving it chance to finish serving user requests. If time's up, then the connection's scope gets cancelled, too. It gets more complex with HTTP pipelining and HTTP2.0, so there is some non-trivial code in our Ktor framework to handle that. However, it does not seem to be needed for general users of coroutines, so we are currently reluctant to add some direct support in our API for that kind of multi-stage shutdown.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,4030677)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,4030677)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4030677" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4030677)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4030677)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/roman-elizarov" onclick="WIKIDOT.page.listeners.userInfo(4763582); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=4763582&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="Roman  Elizarov" style="background-image:url(http://www.wikidot.com/userkarma.php?u=4763582)"/></a><a href="http://www.wikidot.com/user:info/roman-elizarov" onclick="WIKIDOT.page.listeners.userInfo(4763582); return false;" >Roman  Elizarov</a></span>, <span class="odate time_1540048315 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Oct 2018 15:11</span>
		</div>
	</div>
 
                
        
                      
    <div class="post-container" id="fpc-4031539">
                      
		<div class="post" id="post-4031539">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4031539)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4031539">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1540103027 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Oct 2018 06:23</span>
														</div>
			</div>
			<div class="content" id="post-content-4031539">
									

<p>I would do it the same way, but see the discussion with Nathaniel and Matthias above. It feels like I am missing something there.</p>
<p>Btw, it would be interesting to implement the same thing (simple web server, happy eyeballs or such) in the three languages and check how they differ, both in syntax and semantics. The goal would be to find out what the universally acceptable constructs are likely to be, similar to &quot;if&quot;, &quot;for&quot; and &quot;while&quot; in structured programming.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,4031539)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4031539" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4031539)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4031539)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1540103027 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Oct 2018 06:23</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-4031645">
                      
		<div class="post" id="post-4031645">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4031645)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4031645">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=97c543aca1ac7bbcfb5279d0300c8330&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Nathaniel J. Smith (guest)</span> <span class="odate time_1540110115 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Oct 2018 08:21</span>
														</div>
			</div>
			<div class="content" id="post-content-4031645">
									

<p>Yes, we've hesitated to add anything like this to Trio too. But what I'm thinking about are complex programs composed out of multiple pieces: e.g. you might have a single program that hosts several servers speaking different protocols. (It's even reasonably common to have two HTTP servers within the same process: one used by clients, and another on an internal interface for <a href="https://github.com/prometheus/client_python/blob/38e9f48a8860bd133cfcf3c04ae8b404f72c02cc/prometheus_client/exposition.py#L177">exporting metrics</a>.) Hopefully each of your protocol server libraries implement graceful shutdown, but maybe they all expose the functionality using different interfaces, and force you to wire it all up manually. The motivation for something like &quot;soft cancel&quot; is that it would provide a single standard interface for requesting a graceful shutdown that everyone would use, and solve the wiring problem.</p>
<p>And then as a bonus, it seems like it might simplify implementation inside these libraries too? For example if we have a standard way to request graceful shutdown, then we can implement it directly inside our standard server helpers, and higher-level code would get that part for free.</p>
<p>I think Kotlin's cancellation model is pretty different from Trio's, though, so not sure how the idea would even translate. (BTW, out of curiosity, have you considered implementing <a href="https://vorpus.org/blog/timeouts-and-cancellation-for-humans/">cancel scopes</a>?)</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,4031645)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4031645" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4031645)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4031645)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=97c543aca1ac7bbcfb5279d0300c8330&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Nathaniel J. Smith (guest)</span>, <span class="odate time_1540110115 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Oct 2018 08:21</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-4032263">
                      
		<div class="post" id="post-4032263">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4032263)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4032263">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/roman-elizarov" onclick="WIKIDOT.page.listeners.userInfo(4763582); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=4763582&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="Roman  Elizarov" style="background-image:url(http://www.wikidot.com/userkarma.php?u=4763582)"/></a><a href="http://www.wikidot.com/user:info/roman-elizarov" onclick="WIKIDOT.page.listeners.userInfo(4763582); return false;" >Roman  Elizarov</a></span> <span class="odate time_1540159501 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Oct 2018 22:05</span>
														</div>
			</div>
			<div class="content" id="post-content-4032263">
									

<p>Kotlin's approach to cancellation _is_ centered around cancel scopes. In fact, for Kotlin it all started two years ago as a prototype to implement reliable and user-friendly cancellation mechanism that just works. We've studied how cancellation is done in C# and Go and liked none of it. We wanted something that works without users having to write any boilerplate.</p>
<p>In our initial prototype the whole concept was called a Lifetime, then it was renamed to a Job. It was a structured approach to cancellation since early prototypes, in the sense that Job has children hierarchies that are automatically cancelled on parent cancellation or failure.</p>
<p>The only piece we were missing was a syntactic sugar to make launching children a default action. That was the last major change we did before 1.0.0 release. We've used the term &quot;structured concurrency&quot; to label this syntactic change of default, even though nothing had really changed inside. So, now in Kotlin you launch a coroutine in some &quot;CoroutineScope&quot; which is just a convention designed to ensure that your coroutines have a parent by default. In fact, CoroutineScope is just a syntactic construct that keeps are reference to a context with a Job inside.</p>
<p>The whole whole parent-child machinery in Kotlin that works behind the scenes links Kotlin Jobs into hierarchies. Kotlin Jobs are the actual &quot;cancel scopes&quot;. It is because of Jobs we can say `withTimeout(&#8230;) { &#8230; }` and all the code inside the curly braces will get orderly cancelled on timeout, etc.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,4032263)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4032263" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4032263)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4032263)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/roman-elizarov" onclick="WIKIDOT.page.listeners.userInfo(4763582); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=4763582&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="Roman  Elizarov" style="background-image:url(http://www.wikidot.com/userkarma.php?u=4763582)"/></a><a href="http://www.wikidot.com/user:info/roman-elizarov" onclick="WIKIDOT.page.listeners.userInfo(4763582); return false;" >Roman  Elizarov</a></span>, <span class="odate time_1540159501 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Oct 2018 22:05</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-4032296">
                      
		<div class="post" id="post-4032296">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4032296)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4032296">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=97c543aca1ac7bbcfb5279d0300c8330&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Nathaniel J. Smith (guest)</span> <span class="odate time_1540162829 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Oct 2018 23:00</span>
														</div>
			</div>
			<div class="content" id="post-content-4032296">
									

<p>Huh, that's really interesting. I think of cancel scopes as being in opposition to job-scoped cancellation. In Trio, you can enter/leave cancel scopes within a single job, and <a href="https://github.com/python-trio/trio/issues/607">soon</a> it will even be possible to create a cancel scope in one place and then enter it at a different place.</p>
<p>But of course, the job-scoped cancellation that I'm thinking of, and pushing back against, is the kind you see in pthreads or asyncio/twisted or Java's Thread.interrupt. I guess if you have task hierarchies *and* make start-a-new-task-and-wait-for-it as cheap and ceremony-free as possible, then job-scoped cancellation ends up feeling similar to Trio cancel scopes?</p>
<p>In Trio we don't even have objects to represent tasks/jobs (at least in the ordinary user-level API), just like we don't have objects to represent function call frames. It's literally just nursery objects and cancel scope objects.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,4032296)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4032296" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4032296)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4032296)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=97c543aca1ac7bbcfb5279d0300c8330&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Nathaniel J. Smith (guest)</span>, <span class="odate time_1540162829 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Oct 2018 23:00</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-4032486">
                      
		<div class="post" id="post-4032486">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4032486)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4032486">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1540185919 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">22 Oct 2018 05:25</span>
														</div>
			</div>
			<div class="content" id="post-content-4032486">
									

<p>I have though of scopes, but in the end I am working with C where the idiomatic way of doing things is just doing them by hand, no magic involved, so cancel scopes feel non-idiomatic.</p>
<p>That being said, I have a vague feeling (don't take me too seriously though) that we can do better than cancel scopes. I mean, Golang's contexts were better than what we had before (no cancellation at all, mainly) and Trio's way of binding cancellation contexts to scopes is yet much better. But I would love to not have to deal with explicit cancel scopes at all. I am not sure it's possible, but here are some hints:</p>
<p>In libdill the thread bundles (nurseries) work a bit different than in Trio. When the bundle is being closed by its owner the runtime doesn't wait for all threads in the bundle to finish, rather it cancels them immediately.</p>
<p>So (if there were destructors in C) once the bundle runs out of scope or when the stack is being unwound all the threads are automatically canceled, no need for extra syntax.</p>
<p>One ugly thing is that when you explicitly want to wait for the threads in the bundle to finish you have to do that explicitly (bundle_wait function). In that case you can specify deadline for the graceful shutdown.</p>
<p>Another metaphor (not sure how useful): Cancellation in structured concurrency is like return statement in structured programming.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,4032486)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4032486" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4032486)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4032486)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1540185919 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">22 Oct 2018 05:25</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-4032578">
                      
		<div class="post" id="post-4032578">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4032578)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4032578">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/roman-elizarov" onclick="WIKIDOT.page.listeners.userInfo(4763582); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=4763582&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="Roman  Elizarov" style="background-image:url(http://www.wikidot.com/userkarma.php?u=4763582)"/></a><a href="http://www.wikidot.com/user:info/roman-elizarov" onclick="WIKIDOT.page.listeners.userInfo(4763582); return false;" >Roman  Elizarov</a></span> <span class="odate time_1540195644 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">22 Oct 2018 08:07</span>
														</div>
			</div>
			<div class="content" id="post-content-4032578">
									

<p>Too much to write to comment here. We should get together during some conference to discuss it.</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,4032578)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4032578" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4032578)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4032578)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/roman-elizarov" onclick="WIKIDOT.page.listeners.userInfo(4763582); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=4763582&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="Roman  Elizarov" style="background-image:url(http://www.wikidot.com/userkarma.php?u=4763582)"/></a><a href="http://www.wikidot.com/user:info/roman-elizarov" onclick="WIKIDOT.page.listeners.userInfo(4763582); return false;" >Roman  Elizarov</a></span>, <span class="odate time_1540195644 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">22 Oct 2018 08:07</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-4032891">
                      
		<div class="post" id="post-4032891">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4032891)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4032891">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1540210745 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">22 Oct 2018 12:19</span>
														</div>
			</div>
			<div class="content" id="post-content-4032891">
									

<p>+1</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,4032891)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4032891" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4032891)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4032891)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1540210745 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">22 Oct 2018 12:19</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-4046102">
                      
		<div class="post" id="post-4046102">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4046102)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4046102">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=97c543aca1ac7bbcfb5279d0300c8330&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Nathaniel J. Smith (guest)</span> <span class="odate time_1541028960 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">31 Oct 2018 23:36</span>
														</div>
			</div>
			<div class="content" id="post-content-4046102">
									

<blockquote>
<p>But I would love to not have to deal with explicit cancel scopes at all.</p>
</blockquote>
<p>Not sure how that could be possible&#8230; in Trio, there are exactly two places where you deal with explicit cancel scopes:</p>
<ul>
<li>When delimiting the boundaries of the operation that you might want to cancel (&quot;what&quot;)</li>
<li>When calling cancel() or manipulating timeouts (&quot;when:)</li>
</ul>
<p>Both of these kind of have to be explicit! The library can't magically guess what you want to cancel or when.</p>
<p>It's true that you could combine cancel scopes and nursery blocks into a single primitive that does both roles, but I think this would be a bit awkward and non-orthogonal.</p>
<blockquote>
<p>We should get together during some conference to discuss it.</p>
</blockquote>
<p>I wonder if there are any conferences we all go to&#8230; maybe we need to organize a structured concurrency workshop at one!</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,4046102)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4046102" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4046102)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4046102)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=97c543aca1ac7bbcfb5279d0300c8330&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Nathaniel J. Smith (guest)</span>, <span class="odate time_1541028960 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">31 Oct 2018 23:36</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-4047499">
                      
		<div class="post" id="post-4047499">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4047499)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4047499">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1541165972 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">02 Nov 2018 13:39</span>
														</div>
			</div>
			<div class="content" id="post-content-4047499">
									

<p>Dunno. I have a kid so I am not super flexible. I was considering attending FOSSDEM in Feb though.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,4047499)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,4047499)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4047499" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4047499)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4047499)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1541165972 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">02 Nov 2018 13:39</span>
		</div>
	</div>
 
                
        
            </div>
 
            </div>
 
            </div>
 

	
					
      
    <div class="post-container" id="fpc-4029595">
                      
		<div class="post" id="post-4029595">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4029595)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4029595">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=97c543aca1ac7bbcfb5279d0300c8330&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Nathaniel J. Smith (guest)</span> <span class="odate time_1540002594 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Oct 2018 02:29</span>
														</div>
			</div>
			<div class="content" id="post-content-4029595">
									

<p>Oh, and a minor point regarding your &quot;go_process&quot; suggestion: We're using a slightly different API pattern in Trio. Instead of a &quot;start in new [task/thread/process]&quot; primitive, we have a &quot;start in new task&quot; primitive, that we compose with a <a href="https://trio.readthedocs.io/en/latest/reference-core.html#trio.run_sync_in_worker_thread">&quot;switch from task to thread&quot; primitive</a>, and hopefully a &quot;switch from task to process&quot; primitive in the future. This is nice because like you say, threads and processes have their own complexities, and this way we don't have to bake a particular set of choices into the nursery primitive. People can even build their own run-in-process APIs as third-party libraries.</p>
<p>Of course, this is in the context of a Python library, where the GIL makes it a no-brainer to do everything async within a single thread by default. In another language it would make sense to schedule tasks across multiple cores by default.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,4029595)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,4029595)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4029595" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4029595)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4029595)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=97c543aca1ac7bbcfb5279d0300c8330&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Nathaniel J. Smith (guest)</span>, <span class="odate time_1540002594 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Oct 2018 02:29</span>
		</div>
	</div>
 
                
        
                      
    <div class="post-container" id="fpc-4029871">
                      
		<div class="post" id="post-4029871">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4029871)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4029871">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1540017107 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Oct 2018 06:31</span>
														</div>
			</div>
			<div class="content" id="post-content-4029871">
									

<p>The real hard problem, rather than technical, I guess, would be to teach multi-threaded programmers to use yield() when doing heavy number-crunching so that their threads can be cleanly canceled.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,4029871)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,4029871)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4029871" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4029871)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4029871)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1540017107 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Oct 2018 06:31</span>
		</div>
	</div>
 
                
        
                      
    <div class="post-container" id="fpc-4030335">
                      
		<div class="post" id="post-4030335">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4030335)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4030335">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=0c9a3cd677038dce58433d8d48ab602a&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>glaebhoerl (guest)</span> <span class="odate time_1540034589 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Oct 2018 11:23</span>
														</div>
			</div>
			<div class="content" id="post-content-4030335">
									

<p>And the *really hard* problem is making that not have a performance penalty, which people doing heavy number-crunching are often unwilling to accept&#8230;</p>
<p>(The Go folks have some intriguing work on (IIRC) using the same kind of mechanism for &quot;zero-cost preemption&quot; as for &quot;zero-cost exception handling&quot;; meanwhile other smart people allege that this is better at hiding costs than eliminating them; and I'm not qualified to judge.)</p>

							</div>

								
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,4030335)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4030335" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4030335)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4030335)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=0c9a3cd677038dce58433d8d48ab602a&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>glaebhoerl (guest)</span>, <span class="odate time_1540034589 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Oct 2018 11:23</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-4030350">
                      
		<div class="post" id="post-4030350">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4030350)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4030350">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1540035041 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Oct 2018 11:30</span>
														</div>
			</div>
			<div class="content" id="post-content-4030350">
									

<p>We'we seen a similar problem when switching to structured programming. People complained that they can't do the hyperoptimization using gotos, they've complained about the cost of maintaining the call stack and so on. But then the whole thing kind of petered out.</p>
<p>I think we are facing a similar (non-)problem here. For example, the cost of yield() in libdill is, approximately, 20 nanoseconds. Call it once a second and you'll get the perfomance hit of 0.000002%.</p>

							</div>

								
							<div class="changes">
					Last edited on <span class="odate time_1540036011 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Oct 2018 11:46</span>
					by <span class="printuser"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>
					<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.showHistory(event,4030350)"><i class="icon-plus"></i> Show more</a>
				</div>
				<div class="revisions" style="display: none"></div>
					
						<div class="options">
				
																					<a href="javascript:;" onclick="togglePostOptions(event,4030350)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4030350" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4030350)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4030350)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263594" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1540035041 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">20 Oct 2018 11:30</span>
		</div>
	</div>
 
                
        
            </div>
 
                      
    <div class="post-container" id="fpc-4031590">
                      
		<div class="post" id="post-4031590">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4031590)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4031590">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=97c543aca1ac7bbcfb5279d0300c8330&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Nathaniel J. Smith (guest)</span> <span class="odate time_1540106142 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Oct 2018 07:15</span>
														</div>
			</div>
			<div class="content" id="post-content-4031590">
									

<p>&quot;Zero-cost preemption&quot; seems like a misleading term, because it's presumably ignoring the cost of re-warming caches after a context switch, which is a significant and unavoidable part of the cost. But if all you want to do is check for cancellation, that's *very* cheap. Like, a single extremely-predictable (= ~free) branch every few milliseconds or something.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,4031590)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,4031590)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4031590" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4031590)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4031590)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=97c543aca1ac7bbcfb5279d0300c8330&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>Nathaniel J. Smith (guest)</span>, <span class="odate time_1540106142 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">21 Oct 2018 07:15</span>
		</div>
	</div>
 
                
        
            </div>
 
            </div>
 
            </div>
 

	
					
      
    <div class="post-container" id="fpc-4032889">
                      
		<div class="post" id="post-4032889">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,4032889)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-4032889">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=9d6fe34198ca526b4a21342e63fe8306&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>John Belmonte (guest)</span> <span class="odate time_1540210472 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">22 Oct 2018 12:14</span>
														</div>
			</div>
			<div class="content" id="post-content-4032889">
									

<p>Regarding nested nurseries: Python 3.7 added an async version of <a href="https://docs.python.org/3/library/contextlib.html#contextlib.AsyncExitStack">ExitStack</a>, which is a general solution for combining context managers without nesting, and provides the necessary call order.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,4032889)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,4032889)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-4032889" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,4032889)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,4032889)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=9d6fe34198ca526b4a21342e63fe8306&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>John Belmonte (guest)</span>, <span class="odate time_1540210472 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">22 Oct 2018 12:14</span>
		</div>
	</div>
 
                
        
            </div>
 



</div>

        <a href="javascript:;" id="new-post-button" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.newPost(event,null)"
      style="display:  none ; margin-bottom:1em"
    >Add a New Comment</a>


    <div id="new-post-form-container">
        <div id="new-post-preview-div" style="display: none">
            <h1>Post preview:</h1>
            <div class="post-container"></div>
            <div></div>
            <a href="javascript:;" onclick="WIKIDOT.modules.ForumNewPostFormModule.listeners.closePreview(event)" class="btn btn-danger">Close preview</a>
        </div>

        <div id="new-post-div" class="well">
            <form id="new-post-form" onkeypress="return OZONE.utils.disableEnterKey(event)">
                <input type="hidden" name="threadId" value="8117771"/>
                <input type="hidden" name="parentId" value=""/>
                                    <table class="guest-commenting">
                        <tr>
                            <td><input class="text form-control" name="guestName" type="text" maxlength="30" value="" title="Name"/></td>
                            <td>or <a href="#action:login">Sign in as Wikidot user</a></td>
                        </tr>
                        <tr>
                            <td><input class="text form-control" name="guestEmail" type="text" maxlength="50" value="" title="E-mail address"/></td>
                            <td>(will not be published)</td>
                        </tr>
                    </table>
                                <div><textarea id="np-text" name="source" rows="10" cols="50" class="form-control"></textarea></div>
                <div class="change-textarea-size">
                    <a href="javascript:;" onclick="WIKIDOT.utils.changeTextareaRowNo('np-text',-5)">-</a>
                    <a href="javascript:;" onclick="WIKIDOT.utils.changeTextareaRowNo('np-text',5)">+</a>
                </div>
                <div class="edit-help-34">
                    Help: <a href="http://www.wikidot.com/doc:quick-reference" target="_blank">wiki text quick reference</a>                </div>
                                
                <div id="edit-post-captcha"></div>
                
                <div class="buttons alignleft">
                    <input class="btn btn-danger btn-small btn-sm" type="button" value="Cancel" id="np-cancel" onclick="WIKIDOT.modules.ForumNewPostFormModule.listeners.cancel(event)"/>
                    <input class="btn btn-default btn-small btn-sm" type="button" value="Preview" id="np-preview" onclick="WIKIDOT.modules.ForumNewPostFormModule.listeners.preview(event)"/>
                    <input class="btn btn-primary btn-small btn-sm" type="button" value="Post it" id="np-post" onclick="WIKIDOT.modules.ForumNewPostFormModule.listeners.save(event)"/>
                </div>
                    
            </form>
        </div>	

    </div> 
            <script type="text/javascript">
            
            $j(function() {
                WIKIDOT.Editor.init("np-text", "np-editor-panel");
            });
            
        </script>
    
 

<div style="display:none" id="post-options-template">
	<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.showPermalink(event,'%POST_ID%')" class="btn btn-default btn-small btn-sm">Permanent Link</a>
			<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.editPost(event,'%POST_ID%')" class="btn btn-default btn-small btn-sm">Edit</a>
			<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.deletePost(event,'%POST_ID%')" class="btn btn-danger btn-small btn-sm">Delete</a>
</div>
	
			</div>
	
	
	
</div></div>

                    </div>

                    


                    



                    

                    <div id="page-info-break"></div>
                    
                        <div id="page-options-container">
                            
                        </div>
                    
                    <div id="action-area" style="display: none;"></div>
                </div>
            </div>
            
            
            
            <div id="footer" style="display: block; visibility: visible;">
                <div class="options" style="display: block; visibility: visible;">
    <a href="http://www.wikidot.com/doc" id="wikidot-help-button">Help</a>
    &nbsp;|
    <a href="http://www.wikidot.com/legal:terms-of-service" id="wikidot-tos-button">Terms of Service</a>
    &nbsp;|
    <a href="http://www.wikidot.com/legal:privacy-policy" id="wikidot-privacy-button">Privacy</a>
    &nbsp;|
    <a href="javascript:;" id="bug-report-button" onclick="WIKIDOT.page.listeners.pageBugReport(event)">Report a bug</a>
    &nbsp;|
    <a href="javascript:;" id="abuse-report-button" onclick="WIKIDOT.page.listeners.flagPageObjectionable(event)">Flag as objectionable</a>
</div>
Powered by <a href="http://www.wikidot.com">Wikidot.com</a> 
            </div>
            
                <div id="license-area" class="license-area">
                    Unless otherwise stated, the content of this page is licensed under <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 License</a>
                </div>
            
            
            



            <div id="extrac-div-1"><span></span></div><div id="extrac-div-2"><span></span></div><div id="extrac-div-3"><span></span></div>
            
            
            
            
                
            
        </div>
        
    </div>
<!-- These extra divs/spans may be used as catch-alls to add extra imagery. -->
<div id="extra-div-1"><span></span></div><div id="extra-div-2"><span></span></div><div id="extra-div-3"><span></span></div>
<div id="extra-div-4"><span></span></div><div id="extra-div-5"><span></span></div><div id="extra-div-6"><span></span></div>
</div>




</div>
<div id="dummy-ondomready-block" style="display: none;" ></div>
    <!-- Google Analytics load -->
    <script type="text/javascript">
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

    <!-- Quantcast -->
    <script type="text/javascript">
    _qoptions={
        qacct:"p-edL3gsnUjJzw-"
    };
    (function() {
        var qc = document.createElement('script'); qc.type = 'text/javascript'; qc.async = true;
        qc.src = ('https:' == document.location.protocol ? 'https://secure' : 'http://edge') + '.quantserve.com/quant.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(qc, s);
    })();
    </script>
    <noscript>
        <img src="http://pixel.quantserve.com/pixel/p-edL3gsnUjJzw-.gif" style="display: none;" border="0" height="1" width="1" alt="Quantcast"/>
    </noscript>




<div id="page-options-bottom-tips" style="display: none;">
    <div id="edit-button-hovertip">
        Click here to edit contents of this page.    </div>
</div>
<div id="page-options-bottom-2-tips"  style="display: none;">
    <div id="edit-sections-button-hovertip">
        Click here to toggle editing of individual sections of the page (if possible).         Watch headings for an &quot;edit&quot; link when available.    </div>
    <div id="edit-append-button-hovertip">
        Append content without editing the whole page source.    </div>
    <div id="history-button-hovertip">
        Check out how this page has evolved in the past.    </div>
    <div id="discuss-button-hovertip">
        If you want to discuss contents of this page - this is the easiest way to do it.    </div>
    <div id="files-button-hovertip">
        View and manage file attachments for this page.    </div>
    <div id="site-tools-button-hovertip">
        A few useful tools to manage this Site.    </div>
    <div id="backlinks-button-hovertip">
        See pages that link to and include this page.    </div>
    <div id="rename-move-button-hovertip">
        Change the name (also URL address, possibly the category) of the page.    </div>
    <div id="view-source-button-hovertip">
        View wiki source for this page without editing.    </div>
    <div id="parent-page-button-hovertip">  
        View/set parent page (used for creating breadcrumbs and structured layout).    </div>
            <div id="abuse-report-button-hovertip">
            Notify administrators if there is objectionable content in this page.        </div>
        <div id="bug-report-button-hovertip">
            Something does not work as expected? Find out what you can do.        </div>
        <div id="wikidot-help-button-hovertip">
            General Wikidot.com documentation and help section.        </div>
        <div id="wikidot-tos-button-hovertip">
            Wikidot.com Terms of Service - what you can, what you should not etc.        </div>
        <div id="wikidot-privacy-button-hovertip">
            Wikidot.com Privacy Policy.          
        </div>
    </div>
</body>
</html>