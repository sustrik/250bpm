<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
    <title>Getting Rid of ZeroMQ-style Contexts - 250bpm</title>
    
    	<script type="text/javascript" src="http://www.wikidot.com/default__flow/login__CustomDomainScript?site_id=148706"></script>

    
    <script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--javascript/init.combined.js"></script>
    <script  type="text/javascript">
        var URL_HOST = 'www.wikidot.com';
        var URL_DOMAIN = 'wikidot.com';
        var USE_SSL =  true ;
        var URL_STATIC = 'http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9';
        // global request information
        
        var WIKIREQUEST = {};
        WIKIREQUEST.info = {};
        
        WIKIREQUEST.info.domain = "250bpm.com";
        WIKIREQUEST.info.siteId = 148706;
        WIKIREQUEST.info.siteUnixName = "250bpm";
        WIKIREQUEST.info.categoryId = 2550760;
        WIKIREQUEST.info.themeId = 18520;
        WIKIREQUEST.info.requestPageName = "blog:23";
        OZONE.request.timestamp = 1594263513;
        OZONE.request.date = new Date();
        WIKIREQUEST.info.lang = 'en';
                WIKIREQUEST.info.pageUnixName = "blog:23";
        WIKIREQUEST.info.pageId = 17913702;
                        WIKIREQUEST.info.lang = "en";
        OZONE.lang = "en";
        var isUAMobile = !!/Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    </script>
    
    


    
        <script  type="text/javascript">
    
        require.config({
            baseUrl: URL_STATIC + '/common--javascript',
            paths: {
                'jquery.ui': 'jquery-ui.min',
                'jquery.form': 'jquery.form'
            }
        });
    
    </script>
    
    <meta http-equiv="content-type" content="text/html;charset=UTF-8"/>
            
    
    
    
    
    <meta http-equiv="content-language" content="en"/>
    <script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--javascript/WIKIDOT.combined.js"></script>
        
    
    <style type="text/css" id="internal-style">
        
        /* modules */
        
                
        /* theme */
                    @import url(http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--theme/base/css/style.css);
                    @import url(http://250bpm.wdfiles.com/local--theme/250bpm/style.css);
            </style>
    
        
        
        
    <link rel="shortcut icon" href="/local--favicon/favicon.gif"/>
    <link rel="icon" type="image/gif" href="/local--favicon/favicon.gif"/>
    
            <link rel="apple-touch-icon" href="/common--images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="/common--images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="/common--images/apple-touch-icon-114x114.png" />
        
        
            <link rel="alternate" type="application/wiki" title="Edit this page" href="javascript:WIKIDOT.page.listeners.editClick()"/>
    
        <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-18234656-1']);
        _gaq.push(['_setDomainName', 'none']);
        _gaq.push(['_setAllowLinker', true]);
        _gaq.push(['_trackPageview']);

        _gaq.push(['old._setAccount', 'UA-68540-5']);
        _gaq.push(['old._setDomainName', 'none']);
        _gaq.push(['old._setAllowLinker', true]);
        _gaq.push(['old._trackPageview']);

                _gaq.push(['userTracker._setAccount', 'UA-3207370-9']);
        _gaq.push(['userTracker._trackPageview']);
            </script>
    
    <script type="text/javascript">
        window.google_analytics_uacct = 'UA-18234656-1';
        window.google_analytics_domain_name = 'none';
    </script>
    
        <link rel="manifest" href="/onesignal/manifest.json" />
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" acync=""></script>
    <script>
        var OneSignal = window.OneSignal || [];
        OneSignal.push(function() {
          OneSignal.init({
            appId: null,
          });
        });
    </script>
        
<link rel="alternate" type="application/rss+xml" title="Comments for the page &quot;Getting Rid of ZeroMQ-style Contexts&quot;" href="/feed/page/comments-17913702.xml"/><script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--modules/js/forum/ForumCommentsModule.js"></script>
<script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--modules/js/forum/ForumViewThreadModule.js"></script>
<script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--modules/js/forum/ForumViewThreadPostsModule.js"></script>
<script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--3e3a6f7dbcc9/common--modules/js/forum/sub/ForumNewPostFormModule.js"></script>
</head>
<body id="html-body">
<div id="skrollr-body">
<a name="page-top"></a>





<div id="container-wrap-wrap">
    <div id="container-wrap">
        <div id="container">
            <div id="header">
              <h1><a href="/"><span>250bpm</span></a></h1>
                
                
                <!-- google_ad_section_start(weight=ignore) -->
                
                <div id="search-top-box" class="form-search">
    <form id="search-top-box-form" action="dummy" class="input-append">
        <input id="search-top-box-input" class="text empty search-query" type="text" size="15" name="query" value="Search this site" onfocus="if(YAHOO.util.Dom.hasClass(this, 'empty')){YAHOO.util.Dom.removeClass(this,'empty'); this.value='';}"/><input class="button btn" type="submit" name="search" value="Search"/>
    </form>
</div>
                
                
                    <div id="top-bar">
                        

<ul>
<li><a href="/">Home</a></li>
<li><a href="https://github.com/sustrik/cartesian">Cartesian</a></li>
<li><a href="http://libdill.org">Libdill</a></li>
<li><a href="http://nanomsg.org">Nanomsg</a></li>
<li><a href="https://github.com/sustrik/tiles">Tiles</a></li>
<li><a href="http://zero.mq">ZeroMQ</a></li>
<li><a href="/contact">Contact</a></li>
</ul>

                    </div>
                
                <div id="login-status"><a href="javascript:;" onclick="WIKIDOT.page.listeners.createAccount(event)" class="login-status-create-account btn">Create account</a> <span>or</span> <a href="javascript:;" onclick="WIKIDOT.page.listeners.loginClick(event)" class="login-status-sign-in btn btn-primary">Sign in</a> </div>
                <div id="header-extra-div-1"><span></span></div><div id="header-extra-div-2"><span></span></div><div id="header-extra-div-3"><span></span></div>
            </div>
            
            <div id="content-wrap">
                
                    <div id="side-bar">
                        


                        


                        


                    </div>
                
                
                <!-- google_ad_section_end -->
                
                <div id="main-content">
                    <div id="action-area-top"></div>
                    
                    
                        <div id="page-title">
                            Getting Rid of ZeroMQ-style Contexts
                        </div>
                    

                    

                    



                    <div id="page-content">
                        

<div style="width:50em"><div class="list-pages-box">    <div class="list-pages-item">


<p><strong>Previous:</strong> <a href="/blog:22">TCP and heartbeats</a></p>
</div>
    
    
    
    </div><div class="list-pages-box">    <div class="list-pages-item">


<p><strong>Next:</strong> <a href="/blog:24">The Callback Hell</a></p>
</div>
    
    
    
    </div>
<p>I've argued several times (see for example <a href="http://www.aosabook.org/en/zeromq.html#fig.zeromq.multiuse">here</a>) that global state in a library should not be truly global, i.e. stored in C-style global variables, rather an instance of the &quot;global&quot; state should be created upon user request. The reason is that if the two modules within a process used the same low-level library, they would step on each other's toes:</p>
<div class="image-container aligncenter"><img src="http://www.250bpm.com/local--files/blog:23/global1.png" alt="global1.png" class="image" /></div>
<p>Imagine the library C has a global variable foo and setfoo() and getfoo() functions to access it. Now imagine the following sequence of events:</p>
<ol>
<li>Library A: setfoo(10)</li>
<li>Library B: setfoo(20)</li>
<li>Library A: getfoo() &#8212; it expects 10 to be returned but gets 20 instead!</li>
</ol>
<p>While the rule of thumb still holds for libraries in general &#8212; instead of having a single global state, let each module create its own state &#8212; I believe that application of the rule in ZeroMQ was a mistake. ZeroMQ is a <strong>communication</strong> library and, as such, it is an exception to the rule. Communication means sharing of data and thus, communication library's task is to make modules visible each to another, rather than separating them into impervious compartments.</p>
<p>Let's have a look at a concrete example. Imagine that the main program creates a logger object (a PULL socket that writes all received messages to the disk) and wants all the modules loaded into the process to report errors to the logger. As the communication happens within a single process, INPROC transport should be used to convey the log records from individual modules to the logger. However, according to the reasoning above, each module has it's own instance of global state (i.e. its own ZeroMQ context) and the INPROC transport in ZeroMQ doesn't allow for transferring messages between different contexts.</p>
<div class="image-container aligncenter"><img src="http://www.250bpm.com/local--files/blog:23/global2.png" alt="global2.png" class="image" /></div>
<p>The problem could be solved by using IPC or TCP transport instead, however, that opens a security hole: What if attacker connected to the logger from outside and either posted false records or DoS'ed the system with a flood of log requests?</p>
<div class="image-container aligncenter"><img src="http://www.250bpm.com/local--files/blog:23/global3.png" alt="global3.png" class="image" /></div>
<p>So, alternatively, the main program can create the ZeroMQ context and share it with individual modules. That would work as expected, however, there are several problems with the approach:</p>
<ol>
<li>To create a communication channel within a process you need to specify both context and address. Contrast that with all the remaining transports where specifying an address is sufficient to establish a communication.</li>
<li>Context, unlike an address is a pointer to memory. It changes every time the process is restarted. You can't store it in a configuration file, in database, or similar.</li>
<li>Sharing the context pointer between modules may be a problem when modules are written in different languages. Many high-level languages don't even have a native concept of pointer, instead they use ideosyncratic hacks to represent the pointer, such as storing it in an integer value, wrapping the pointer in the &quot;native object&quot; etc. There's no much chance that these representations of the context pointer would be compatible &#8212; and thus trasferrable &#8212; among any particular pair of languages.</li>
</ol>
<p>Given the above, I believe that I've made a mistake by introducing contexts into ZeroMQ. Contexts are designed for strict separation between modules which is not a desirable feature in a communication library.</p>
<p>Thus, in <a href="http://nanomsg.org">nanomsg</a> I've got rid of contexts. User creates sockets and that's it. You don't need to create a context beforehand.</p>
<p>At the same time INPROC addresses are visible within the process as a whole, rather than being restricted only to the local module/context. This way it is easy to create a communication channel between modules inside a process.</p>
<p>Additional benefit of the change is the simplification of the API. Compare the following two snippets of code. First one opens a connection a sends a message in ZeroMQ:</p>
<div class="code">
<pre>
<code>void *ctx = zmq_ctx_new ();
void *s = zmq_socket (ctx, ZMQ_PUSH);
zmq_connect (s, &quot;tcp://192.168.0.111:5555&quot;);
zmq_send (s, &quot;ABC&quot;, 3, 0);
zmq_close (s);
zmq_ctx_destroy (ctx);</code>
</pre></div>
<p>And here's the same code for nanomsg:</p>
<div class="code">
<pre>
<code>int s = nn_socket (AF_SP, NN_PUSH);
nn_connect (s, &quot;tcp://192.168.0.111:5555&quot;);
nn_send (s, &quot;ABC&quot;, 3, 0);
nn_close (s);</code>
</pre></div>
<p>Of course, removing the contexts has some repercussions on the semantics of the system. For example, nn_close() becomes a blocking function. It may wait for &quot;linger&quot; period to send any pending outbound data before closing the socket. In ZeroMQ, zmq_close() is completed immediately and waiting is postponed to zmq_ctx_destroy() function which, given the removal of contexts, has no equivalent in nanomsg.</p>
<p>While that may be considered a drawback in some ways, in other ways it is a desirable behaviour. For example, after socket is closed, the system resources allocated by the socket &#8212; such as TCP port or IPC file &#8212; are guaranteed to be released and thus ready to be re-used. However, that's a topic for another blog post.</p>
<p><strong>Martin SÃºstrik, May 14th, 2013</strong></p>
<div class="list-pages-box">    <div class="list-pages-item">


<p><strong>Previous:</strong> <a href="/blog:22">TCP and heartbeats</a></p>
</div>
    
    
    
    </div><div class="list-pages-box">    <div class="list-pages-item">


<p><strong>Next:</strong> <a href="/blog:24">The Callback Hell</a></p>
</div>
    
    
    
    </div>
<div style="height:2em"></div>
<div class="comments-box">
		
	<div class="options" id="comments-options-hidden" style="display: none">
		<a href="javascript:;" onclick="WIKIDOT.modules.ForumCommentsModule.listeners.showComments(event)">Show Comments</a> 
	</div>
		
	<div id="thread-container" class="thread-container" style="margin-top: 1em">
					


<script type="text/javascript">
	WIKIDOT.forumThreadId = 652544;
</script>


	<div class="options" id="comments-options-shown">
		<a href="javascript:;" onclick="WIKIDOT.modules.ForumCommentsModule.listeners.hideComments(event)" class="btn btn-default btn-small btn-sm">Hide All Comments</a> 
		<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.unfoldAll(event)" class="btn btn-default btn-small btn-sm">Unfold All</a> 
		<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.foldAll(event)" class="btn btn-default btn-small btn-sm">Fold All</a>
	</div>

<div id="thread-container-posts" style="display: none">
    



	
					
      
    <div class="post-container" id="fpc-1774357">
                      
		<div class="post" id="post-1774357">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1774357)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1774357">
																		Shutdown...
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/jhawk28" onclick="WIKIDOT.page.listeners.userInfo(865475); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=865475&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="jhawk28" style="background-image:url(http://www.wikidot.com/userkarma.php?u=865475)"/></a><a href="http://www.wikidot.com/user:info/jhawk28" onclick="WIKIDOT.page.listeners.userInfo(865475); return false;" >jhawk28</a></span> <span class="odate time_1368545670 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">14 May 2013 15:34</span>
														</div>
			</div>
			<div class="content" id="post-content-1774357">
									

<p>How do you plan on shutdown?</p>
<p>In ZeroMQ for example, I often setup different threads to handle various sockets. The threads will just listen for data and process it (think something like a worker thread). In ZeroMQ, we currently have a context.term(). This interrupts any threads or pollers to throw a ZMQException (in Java). I can then catch the exception and call socket.close() in each thread and close out the loops.</p>
<p>A possible solution is for the socket.close() to be thread-safe. I can then close the sockets from my main thread.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1774357)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1774357)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1774357" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1774357)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1774357)">Shutdown...</a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/jhawk28" onclick="WIKIDOT.page.listeners.userInfo(865475); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=865475&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="jhawk28" style="background-image:url(http://www.wikidot.com/userkarma.php?u=865475)"/></a><a href="http://www.wikidot.com/user:info/jhawk28" onclick="WIKIDOT.page.listeners.userInfo(865475); return false;" >jhawk28</a></span>, <span class="odate time_1368545670 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">14 May 2013 15:34</span>
		</div>
	</div>
 
                
                	


        
                      
    <div class="post-container" id="fpc-1774634">
                      
		<div class="post" id="post-1774634">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1774634)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1774634">
																		Re: Shutdown...
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1368561483 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">14 May 2013 19:58</span>
														</div>
			</div>
			<div class="content" id="post-content-1774634">
									

<p>The term() function still exists, but it is not longer a required step in the process shutdown. It is an optional utility that unblocks any blocking calls and causes nanomsg functions to return ETERM from that point on.</p>
<p>Actual deallocation of the global resources happens when last socket is closed, irrespectively of whether nn_term() was used or not.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1774634)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1774634)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1774634" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1774634)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1774634)">Re: Shutdown...</a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1368561483 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">14 May 2013 19:58</span>
		</div>
	</div>
 
                
        
            </div>
 
            </div>
 

	
					
      
    <div class="post-container" id="fpc-1774434">
                      
		<div class="post" id="post-1774434">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1774434)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1774434">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=010f7ab662febdc1b2889e02f4f3e02d&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>zot (guest)</span> <span class="odate time_1368550369 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">14 May 2013 16:52</span>
														</div>
			</div>
			<div class="content" id="post-content-1774434">
									

<p>Two comments:</p>
<p>1)<br />
Every API calls needs to provide a non-blocking variant<br />
e.g. nn_close() always blocking will greatly complicate event-driven<br />
code that assumes no blocking&#8230;</p>
<p>2)<br />
To avoid locking between threads, are you planning to use<br />
an implicit per-thread context (i.e. thread-local variable) in conjunction<br />
with the shared/locked global state?</p>
<p>If the core of the library makes use of a context, then many options are possible:</p>
<p>1) Provide a shared implicit context for the entire process<br />
+ the simple API you outlined above that uses the global context</p>
<p>2) An implicit per-thread context (totally independent or shared between some threads)</p>
<p>3) Multiple independent contexts under full programmer control</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1774434)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1774434)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1774434" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1774434)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1774434)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=010f7ab662febdc1b2889e02f4f3e02d&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>zot (guest)</span>, <span class="odate time_1368550369 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">14 May 2013 16:52</span>
		</div>
	</div>
 
                
        
                      
    <div class="post-container" id="fpc-1774646">
                      
		<div class="post" id="post-1774646">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1774646)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1774646">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1368562160 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">14 May 2013 20:09</span>
														</div>
			</div>
			<div class="content" id="post-content-1774646">
									

<p>1) Same behaviour is exhibited by zmq_term(). How do you handle it there? This is just moving it to close() function. That being said, the only non-half-assed (full-assed?) solution is to move the entire messaging layer into kernel space and thus allow it to send pending data even after the process it terminated.</p>
<p>2) Global state is simply global, guarded by a mutex. However, the mutex is locked only when sockets are sreated or closed. The critical path (send/recv) doesn't touch the global state and thus requires no locking.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1774646)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1774646)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1774646" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1774646)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1774646)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1368562160 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">14 May 2013 20:09</span>
		</div>
	</div>
 
                
        
            </div>
 
            </div>
 

	
					
      
    <div class="post-container" id="fpc-1774469">
                      
		<div class="post" id="post-1774469">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1774469)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1774469">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/pieterh" onclick="WIKIDOT.page.listeners.userInfo(99); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=99&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="pieterh" style="background-image:url(http://www.wikidot.com/userkarma.php?u=99)"/></a><a href="http://www.wikidot.com/user:info/pieterh" onclick="WIKIDOT.page.listeners.userInfo(99); return false;" >pieterh</a></span> <span class="odate time_1368552731 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">14 May 2013 17:32</span>
														</div>
			</div>
			<div class="content" id="post-content-1774469">
									

<p>Contexts were a design mistake, yes. There are use cases for them but they should not be part of the basic API. However you don't need blocking as far as I can tell. What most apps do, and what the API should do, is maintain one context by default. A static thread safe object. Making this visible to the user and asking the user to take control was too complex (especially when we still asked the user to specify how many i/o threads to use&#8230;)</p>
<p>Still, with no contexts how do you shut-down the whole engine safely?</p>
<p>BTW the title of your post is misleading, you are not getting rid of ZeroMQ contexts. :)</p>

							</div>

										<div class="signature">
					<hr class="signature-separator"/>
					

<p><a href="http://ipocracy.wikidot.com/main:portfolio">Portfolio</a></p>

				</div>
					
							<div class="changes">
					Last edited on <span class="odate time_1368552783 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">14 May 2013 17:33</span>
					by <span class="printuser"><a href="http://www.wikidot.com/user:info/pieterh" onclick="WIKIDOT.page.listeners.userInfo(99); return false;" >pieterh</a></span>
					<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.showHistory(event,1774469)"><i class="icon-plus"></i> Show more</a>
				</div>
				<div class="revisions" style="display: none"></div>
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1774469)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1774469)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1774469" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1774469)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1774469)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/pieterh" onclick="WIKIDOT.page.listeners.userInfo(99); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=99&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="pieterh" style="background-image:url(http://www.wikidot.com/userkarma.php?u=99)"/></a><a href="http://www.wikidot.com/user:info/pieterh" onclick="WIKIDOT.page.listeners.userInfo(99); return false;" >pieterh</a></span>, <span class="odate time_1368552731 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">14 May 2013 17:32</span>
		</div>
	</div>
 
                
        
                      
    <div class="post-container" id="fpc-1774650">
                      
		<div class="post" id="post-1774650">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1774650)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1774650">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1368562298 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">14 May 2013 20:11</span>
														</div>
			</div>
			<div class="content" id="post-content-1774650">
									

<p>Shut down is done when the last socket is closed. It requires some synchronisation kung-fu but it's doable.</p>
<p>You are right about the title. I've changed it to &quot;ZeroMQ-style contexts&quot;.</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1774650)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1774650)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1774650" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1774650)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1774650)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1368562298 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">14 May 2013 20:11</span>
		</div>
	</div>
 
                
        
            </div>
 
            </div>
 

	
					
      
    <div class="post-container" id="fpc-1777628">
                      
		<div class="post" id="post-1777628">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1777628)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1777628">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=803e178f33b9d1244688d2ab458db4d0&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>erik (guest)</span> <span class="odate time_1368818412 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">17 May 2013 19:20</span>
														</div>
			</div>
			<div class="content" id="post-content-1777628">
									

<p>Forking doesn't work well in 0mq. When fork()'ing, sockets are dup'ed, But the new (child) can't &quot;close&quot; them&#8230; because the context can't be reused. Then, if the parent tries to exit and reconnect, the dup'ed sockets block the bind() call.</p>
<p>After a fork, user should call nm_postfork(MODE)</p>
<p>Check to see if the pid associated with the socket is the same as the pid that opened it. if not, duplicated queues are cleared, and &quot;file descriptor based&quot; (tcp, unix) sockets are closed. All sockets are still valid in the child, but they are all &quot;closed&quot;.</p>
<p>Especially when there are no &quot;contexts&quot; you need a way of handling fork()</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1777628)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1777628)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1777628" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1777628)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1777628)"></a> by <span class="printuser avatarhover"><a href="javascript:;"><img class="small" src="http://www.gravatar.com/avatar.php?gravatar_id=803e178f33b9d1244688d2ab458db4d0&amp;default=http://www.wikidot.com/common--images/avatars/default/a16.png&amp;size=16" alt=""/></a>erik (guest)</span>, <span class="odate time_1368818412 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">17 May 2013 19:20</span>
		</div>
	</div>
 
                
        
                      
    <div class="post-container" id="fpc-1777643">
                      
		<div class="post" id="post-1777643">
		<div class="long">
			<div class="head">
									<div class="options">
						<a href="javascript:;" onclick="togglePostFold(event,1777643)" class="btn btn-default btn-small btn-sm">Fold</a>
					</div>
								<div class="title" id="post-title-1777643">
																		
															</div>
				<div class="info">
					<span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span> <span class="odate time_1368819847 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">17 May 2013 19:44</span>
														</div>
			</div>
			<div class="content" id="post-content-1777643">
									

<p>Wouldn't rigorously setting CLOEXEC on all fds do the job?</p>

							</div>

								
					
						<div class="options">
				
													<strong><a href="javascript:;" onclick="postReply(event,1777643)" class="btn btn-primary btn-small btn-sm">Reply</a></strong> 
																	<a href="javascript:;" onclick="togglePostOptions(event,1777643)" class="btn btn-default btn-small btn-sm">Options</a>
							</div>
									
			<div id="post-options-1777643" class="options" style="display: none">
			</div>
		</div>
		<div class="short">
							<a class="options btn btn-default btn-mini btn-xs" href="javascript:;" onclick="togglePostFold(event,1777643)" c>Unfold</a>
						<a class="title" href="javascript:;" onclick="togglePostFold(event,1777643)"></a> by <span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;"  ><img class="small" src="http://www.wikidot.com/avatar.php?userid=939&amp;amp;size=small&amp;amp;timestamp=1594263513" alt="martin_sustrik" style="background-image:url(http://www.wikidot.com/userkarma.php?u=939)"/></a><a href="http://www.wikidot.com/user:info/martin-sustrik" onclick="WIKIDOT.page.listeners.userInfo(939); return false;" >martin_sustrik</a></span>, <span class="odate time_1368819847 format_%25e%20%25b%20%25Y%2C%20%25H%3A%25M%7Cagohover">17 May 2013 19:44</span>
		</div>
	</div>
 
                
        
            </div>
 
            </div>
 



</div>

        <a href="javascript:;" id="new-post-button" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.newPost(event,null)"
      style="display:  none ; margin-bottom:1em"
    >Add a New Comment</a>


    <div id="new-post-form-container">
        <div id="new-post-preview-div" style="display: none">
            <h1>Post preview:</h1>
            <div class="post-container"></div>
            <div></div>
            <a href="javascript:;" onclick="WIKIDOT.modules.ForumNewPostFormModule.listeners.closePreview(event)" class="btn btn-danger">Close preview</a>
        </div>

        <div id="new-post-div" class="well">
            <form id="new-post-form" onkeypress="return OZONE.utils.disableEnterKey(event)">
                <input type="hidden" name="threadId" value="652544"/>
                <input type="hidden" name="parentId" value=""/>
                                    <table class="guest-commenting">
                        <tr>
                            <td><input class="text form-control" name="guestName" type="text" maxlength="30" value="" title="Name"/></td>
                            <td>or <a href="#action:login">Sign in as Wikidot user</a></td>
                        </tr>
                        <tr>
                            <td><input class="text form-control" name="guestEmail" type="text" maxlength="50" value="" title="E-mail address"/></td>
                            <td>(will not be published)</td>
                        </tr>
                    </table>
                                <div><textarea id="np-text" name="source" rows="10" cols="50" class="form-control"></textarea></div>
                <div class="change-textarea-size">
                    <a href="javascript:;" onclick="WIKIDOT.utils.changeTextareaRowNo('np-text',-5)">-</a>
                    <a href="javascript:;" onclick="WIKIDOT.utils.changeTextareaRowNo('np-text',5)">+</a>
                </div>
                <div class="edit-help-34">
                    Help: <a href="http://www.wikidot.com/doc:quick-reference" target="_blank">wiki text quick reference</a>                </div>
                                
                <div id="edit-post-captcha"></div>
                
                <div class="buttons alignleft">
                    <input class="btn btn-danger btn-small btn-sm" type="button" value="Cancel" id="np-cancel" onclick="WIKIDOT.modules.ForumNewPostFormModule.listeners.cancel(event)"/>
                    <input class="btn btn-default btn-small btn-sm" type="button" value="Preview" id="np-preview" onclick="WIKIDOT.modules.ForumNewPostFormModule.listeners.preview(event)"/>
                    <input class="btn btn-primary btn-small btn-sm" type="button" value="Post it" id="np-post" onclick="WIKIDOT.modules.ForumNewPostFormModule.listeners.save(event)"/>
                </div>
                    
            </form>
        </div>	

    </div> 
            <script type="text/javascript">
            
            $j(function() {
                WIKIDOT.Editor.init("np-text", "np-editor-panel");
            });
            
        </script>
    
 

<div style="display:none" id="post-options-template">
	<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.showPermalink(event,'%POST_ID%')" class="btn btn-default btn-small btn-sm">Permanent Link</a>
			<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.editPost(event,'%POST_ID%')" class="btn btn-default btn-small btn-sm">Edit</a>
			<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.deletePost(event,'%POST_ID%')" class="btn btn-danger btn-small btn-sm">Delete</a>
</div>
	
			</div>
	
	
	
</div></div>

                    </div>

                    


                    



                    

                    <div id="page-info-break"></div>
                    
                        <div id="page-options-container">
                            
                        </div>
                    
                    <div id="action-area" style="display: none;"></div>
                </div>
            </div>
            
            
            
            <div id="footer" style="display: block; visibility: visible;">
                <div class="options" style="display: block; visibility: visible;">
    <a href="http://www.wikidot.com/doc" id="wikidot-help-button">Help</a>
    &nbsp;|
    <a href="http://www.wikidot.com/legal:terms-of-service" id="wikidot-tos-button">Terms of Service</a>
    &nbsp;|
    <a href="http://www.wikidot.com/legal:privacy-policy" id="wikidot-privacy-button">Privacy</a>
    &nbsp;|
    <a href="javascript:;" id="bug-report-button" onclick="WIKIDOT.page.listeners.pageBugReport(event)">Report a bug</a>
    &nbsp;|
    <a href="javascript:;" id="abuse-report-button" onclick="WIKIDOT.page.listeners.flagPageObjectionable(event)">Flag as objectionable</a>
</div>
Powered by <a href="http://www.wikidot.com">Wikidot.com</a> 
            </div>
            
                <div id="license-area" class="license-area">
                    Unless otherwise stated, the content of this page is licensed under <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 License</a>
                </div>
            
            
            



            <div id="extrac-div-1"><span></span></div><div id="extrac-div-2"><span></span></div><div id="extrac-div-3"><span></span></div>
            
            
            
            
                
            
        </div>
        
    </div>
<!-- These extra divs/spans may be used as catch-alls to add extra imagery. -->
<div id="extra-div-1"><span></span></div><div id="extra-div-2"><span></span></div><div id="extra-div-3"><span></span></div>
<div id="extra-div-4"><span></span></div><div id="extra-div-5"><span></span></div><div id="extra-div-6"><span></span></div>
</div>




</div>
<div id="dummy-ondomready-block" style="display: none;" ></div>
    <!-- Google Analytics load -->
    <script type="text/javascript">
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

    <!-- Quantcast -->
    <script type="text/javascript">
    _qoptions={
        qacct:"p-edL3gsnUjJzw-"
    };
    (function() {
        var qc = document.createElement('script'); qc.type = 'text/javascript'; qc.async = true;
        qc.src = ('https:' == document.location.protocol ? 'https://secure' : 'http://edge') + '.quantserve.com/quant.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(qc, s);
    })();
    </script>
    <noscript>
        <img src="http://pixel.quantserve.com/pixel/p-edL3gsnUjJzw-.gif" style="display: none;" border="0" height="1" width="1" alt="Quantcast"/>
    </noscript>




<div id="page-options-bottom-tips" style="display: none;">
    <div id="edit-button-hovertip">
        Click here to edit contents of this page.    </div>
</div>
<div id="page-options-bottom-2-tips"  style="display: none;">
    <div id="edit-sections-button-hovertip">
        Click here to toggle editing of individual sections of the page (if possible).         Watch headings for an &quot;edit&quot; link when available.    </div>
    <div id="edit-append-button-hovertip">
        Append content without editing the whole page source.    </div>
    <div id="history-button-hovertip">
        Check out how this page has evolved in the past.    </div>
    <div id="discuss-button-hovertip">
        If you want to discuss contents of this page - this is the easiest way to do it.    </div>
    <div id="files-button-hovertip">
        View and manage file attachments for this page.    </div>
    <div id="site-tools-button-hovertip">
        A few useful tools to manage this Site.    </div>
    <div id="backlinks-button-hovertip">
        See pages that link to and include this page.    </div>
    <div id="rename-move-button-hovertip">
        Change the name (also URL address, possibly the category) of the page.    </div>
    <div id="view-source-button-hovertip">
        View wiki source for this page without editing.    </div>
    <div id="parent-page-button-hovertip">  
        View/set parent page (used for creating breadcrumbs and structured layout).    </div>
            <div id="abuse-report-button-hovertip">
            Notify administrators if there is objectionable content in this page.        </div>
        <div id="bug-report-button-hovertip">
            Something does not work as expected? Find out what you can do.        </div>
        <div id="wikidot-help-button-hovertip">
            General Wikidot.com documentation and help section.        </div>
        <div id="wikidot-tos-button-hovertip">
            Wikidot.com Terms of Service - what you can, what you should not etc.        </div>
        <div id="wikidot-privacy-button-hovertip">
            Wikidot.com Privacy Policy.          
        </div>
    </div>
</body>
</html>